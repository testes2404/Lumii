<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lumii • Cadastro de Materiais</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    /* — Reset & Base — */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { width:100%; height:100%; background:#121212; font-family:'Poppins',sans-serif; color:#FFF; }
    body { display:flex; justify-content:center; align-items:center; position:relative; }

    /* — Badge de usuário fixo no canto superior direito — */
    #userBadge {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: rgba(30,30,30,0.6);
      backdrop-filter: blur(6px);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #FFF;
      white-space: nowrap;
      z-index: 1000;
    }

    /* — Glass Panel — */
    .glass-panel {
      width: 400px;
      max-width: 90%;
      padding: 2rem;
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .glass-panel h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      font-weight: 600;
    }

    /* — Formulário — */
    .form-group {
      margin-bottom: 1rem;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: .3rem;
      font-weight: 500;
      font-size: .95rem;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group input[type="file"] {
      width:100%;
      padding:.7rem 1rem;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 8px;
      color: #FFF;
      font-size: 1rem;
    }
    .form-group textarea { resize: vertical; min-height:100px; }

    button[type="submit"] {
      width:100%;
      padding:.75rem;
      background: rgba(76,175,80,0.9);
      border:none;
      border-radius:8px;
      font-size:1rem;
      font-weight:600;
      color:#121212;
      cursor:pointer;
      transition: background .2s ease-in-out;
    }
    button[type="submit"]:hover {
      background: rgba(76,175,80,1);
    }

    /* — Toast Sucesso — */
    #toast {
      display:none;
      position: fixed;
      bottom: 1.5rem;
      left:50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: #fff;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      font-size: .95rem;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <!-- Badge fixo fora do painel -->
  <div id="userBadge">Carregando...</div>

  <div class="glass-panel">
    <h1>Salvar Material</h1>
    <form id="materialForm">
      <div class="form-group">
        <label for="matName">Nome</label>
        <input type="text" id="matName" placeholder="Ex: Manual de Boas Práticas" required>
      </div>
      <div class="form-group">
        <label for="matDesc">Explicação</label>
        <textarea id="matDesc" placeholder="Descreva o conteúdo..." required></textarea>
      </div>
      <div class="form-group">
        <label for="matFile">Arquivo (PDF ou Vídeo)</label>
        <input type="file" id="matFile" accept=".pdf,video/*" required>
      </div>
      <button type="submit">Salvar</button>
    </form>
  </div>

  <div id="toast">✅ Material salvo com sucesso!</div>

  <script src="../js/firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      getDocs,
      query,
      where
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';

    const firebaseConfig = await loadFirebaseConfig();

    const app     = initializeApp(firebaseConfig);
    const auth    = getAuth(app);
    const db      = getFirestore(app);
    const storage = getStorage(app);

    const badge = document.getElementById('userBadge');
    let companyEmail = '';

    // Exibe email/full_name no badge fixo
    onAuthStateChanged(auth, async user => {
      if (user?.email) {
        companyEmail = user.email;
        try {
          const profilesRef = collection(db, 'profiles');
          const q = query(profilesRef, where('email','==',companyEmail));
          const snap = await getDocs(q);
          badge.textContent = !snap.empty
            ? snap.docs[0].data().full_name
            : companyEmail;
        } catch {
          badge.textContent = companyEmail;
        }
      } else {
        badge.textContent = 'Não autenticado';
      }
    });

    const toast = document.getElementById('toast');
    function showToast() {
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    document.getElementById('materialForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('matName').value.trim();
      const desc = document.getElementById('matDesc').value.trim();
      const fileInput = document.getElementById('matFile');
      if (!fileInput.files.length || !companyEmail) return;

      const file = fileInput.files[0];
      const ts = Date.now();
      const storageRef = ref(storage, `materiais/${companyEmail}/${ts}_${file.name}`);
      try {
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        await addDoc(collection(db, 'materiais_aperfeicoamento'), {
          nome: name,
          descricao: desc,
          arquivoUrl: url,
          tipo: file.type.startsWith('video/') ? 'video' : 'pdf',
          empresaEmail: companyEmail,
          criadoEm: serverTimestamp()
        });
        showToast();
        e.target.reset();
      } catch (err) {
        console.error('Erro ao salvar material:', err);
        alert('Falha ao salvar. Veja o console.');
      }
    });
  </script>
</body>
</html>
