<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Candidaturas - Sistema de RH</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body { background-color: #f8f9fa; }
        .card-icon { font-size: 2.5rem; opacity: 0.3; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .placeholder-glow .fs-2 { min-height: 48px; }
        .chart-container { position: relative; height: 350px; width: 100%; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-graph-up-arrow"></i> Sistema de RH</a>
            <div id="userEmailBadge" class="text-white ms-auto me-3 small"></div>
        </div>
    </nav>

    <main class="container-fluid mt-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Dashboard de Métricas</h1>
        </div>

        <div class="row g-4 mb-4 placeholder-glow">
            <div class="col-md-6 col-xl-3">
                <div class="card shadow-sm">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-muted">Total de Candidaturas</h5>
                            <p id="total-candidaturas" class="card-text fs-2 fw-bold placeholder col-4">0</p>
                        </div>
                        <i class="bi bi-people-fill card-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card shadow-sm">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-muted">Vagas Abertas</h5>
                            <p id="vagas-abertas" class="card-text fs-2 fw-bold placeholder col-3">0</p>
                        </div>
                        <i class="bi bi-briefcase-fill card-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card shadow-sm">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-muted">Contratados (Mês)</h5>
                            <p id="contratados" class="card-text fs-2 fw-bold text-success placeholder col-3">0</p>
                        </div>
                        <i class="bi bi-person-check-fill card-icon text-success"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-3">
                <div class="card shadow-sm">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-muted">Taxa de Conversão</h5>
                            <p id="taxa-conversao" class="card-text fs-2 fw-bold placeholder col-4">0%</p>
                        </div>
                         <i class="bi bi-percent card-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        Candidaturas nos Últimos 6 Meses
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="candidaturasMensaisChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card shadow-sm">
            <div class="card-header">Últimas Candidaturas Recebidas</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Candidato(a)</th>
                                <th scope="col">ID da Vaga</th>
                                <th scope="col">Data</th>
                                <th scope="col">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-candidaturas-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDjys-U4aBy5SMXTasOp_TsfqziuqnEc9o",
            authDomain: "mini-genio-c204d.firebaseapp.com",
            projectId: "mini-genio-c204d",
            storageBucket: "mini-genio-c204d.firebasestorage.app",
            messagingSenderId: "553494129644",
            appId: "1:553494129644:web:cc6f0de9d013392fc4eec9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const companyEmail = localStorage.getItem('companyEmail');
        document.getElementById('userEmailBadge').textContent = companyEmail ? `Logado como: ${companyEmail}` : 'Não Logado';
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (!companyEmail) {
                document.querySelector('main').innerHTML = `<div class="alert alert-warning">Empresa não identificada. Faça o login na página principal para acessar os relatórios.</div>`;
                return;
            }

            try {
                const candidaturasRef = collection(db, 'candidaturas-realizadas');
                const vagasRef = collection(db, 'vagas');
                const qCandidaturas = query(candidaturasRef, where('companyEmail', '==', companyEmail));
                const qVagas = query(vagasRef, where('companyEmail', '==', companyEmail));

                const [candidaturasSnap, vagasSnap] = await Promise.all([
                    getDocs(qCandidaturas),
                    getDocs(qVagas)
                ]);

                const todasCandidaturas = [];
                candidaturasSnap.forEach(doc => todasCandidaturas.push(doc.data()));

                const hoje = new Date();
                const contratadosNoMes = todasCandidaturas.filter(c => {
                    if (!c.timestamp || c.status !== 'Aprovado') return false;
                    const dataCandidatura = c.timestamp.toDate();
                    return dataCandidatura.getMonth() === hoje.getMonth() && dataCandidatura.getFullYear() === hoje.getFullYear();
                }).length;
                
                const candidaturasOrdenadas = todasCandidaturas
                    .filter(c => c.timestamp)
                    .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

                const dadosGrafico = processarDadosGrafico(todasCandidaturas);

                updateKPIs({
                    total: todasCandidaturas.length,
                    vagas: vagasSnap.size,
                    contratados: contratadosNoMes
                });
                
                renderizarGrafico(dadosGrafico.labels, dadosGrafico.data);
                
                updateTabela(candidaturasOrdenadas.slice(0, 10));

            } catch (error) {
                console.error("Erro ao processar dados:", error);
                document.querySelector('main').innerHTML = `<div class="alert alert-danger"><strong>Ocorreu um erro.</strong><br>Verifique se os dados na sua coleção estão corretos.</div>`;
            }
        });

        function updateKPIs(data) {
            document.getElementById('total-candidaturas').textContent = data.total;
            document.getElementById('vagas-abertas').textContent = data.vagas;
            document.getElementById('contratados').textContent = data.contratados;
            const taxaConversao = data.total > 0 ? ((data.contratados / data.total) * 100).toFixed(1) : 0;
            document.getElementById('taxa-conversao').textContent = `${taxaConversao}%`;
            document.querySelectorAll('.placeholder').forEach(el => el.classList.remove('placeholder'));
        }
        
        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();
            switch (statusLower) {
                case 'aprovado':
                case 'contratado':
                    return 'bg-success';
                case 'em entrevista':
                    return 'bg-warning text-dark';
                case 'rejeitado':
                    return 'bg-danger';
                case 'triagem':
                case 'candidatura_feita':
                    return 'bg-info text-dark';
                default:
                    return 'bg-secondary';
            }
        }

        // NOVO: Funções para mascarar os dados sensíveis
        function maskEmail(email) {
            if (!email || email.indexOf('@') === -1) return 'Email inválido';
            const [localPart, domain] = email.split('@');
            if (localPart.length <= 3) {
                return `${localPart.substring(0, 1)}...` + '@' + domain;
            }
            return `${localPart.substring(0, 3)}...` + '@' + domain;
        }

        function maskId(id) {
            if (!id || typeof id !== 'string') return 'ID inválido';
            return `${id.substring(0, 8)}...`;
        }

        function updateTabela(candidaturas) {
            const tabelaBody = document.getElementById('tabela-candidaturas-body');
            tabelaBody.innerHTML = '';
            if (candidaturas.length === 0) {
                tabelaBody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhuma candidatura encontrada.</td></tr>';
                return;
            }
            candidaturas.forEach(candidatura => {
                const dataFormatada = candidatura.timestamp.toDate().toLocaleDateString('pt-BR');
                const badgeClass = getStatusBadge(candidatura.status);
                
                // Aplica o mascaramento antes de exibir
                const emailMascarado = maskEmail(candidatura.userEmail);
                const idMascarado = maskId(candidatura.vagaId);

                const row = `
                    <tr>
                        <td>${emailMascarado}</td>
                        <td><small>${idMascarado}</small></td>
                        <td>${dataFormatada}</td>
                        <td><span class="badge ${badgeClass}">${candidatura.status || 'N/A'}</span></td>
                    </tr>
                `;
                tabelaBody.innerHTML += row;
            });
        }
        
        function processarDadosGrafico(candidaturas) {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const contagemPorMes = {};
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const chave = `${meses[d.getMonth()]}/${d.getFullYear() % 100}`;
                contagemPorMes[chave] = 0;
            }
            
            candidaturas.forEach(c => {
                if(c.timestamp) {
                    const data = c.timestamp.toDate();
                    const chave = `${meses[data.getMonth()]}/${data.getFullYear() % 100}`;
                    if(chave in contagemPorMes) {
                        contagemPorMes[chave]++;
                    }
                }
            });
            
            return {
                labels: Object.keys(contagemPorMes),
                data: Object.values(contagemPorMes)
            };
        }
        
        function renderizarGrafico(labels, data) {
            const ctx = document.getElementById('candidaturasMensaisChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Candidaturas',
                        data: data,
                        backgroundColor: 'rgba(0, 123, 255, 0.7)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false }, tooltip: { displayColors: false } }
                }
            });
        }
    </script>
</body>
</html>