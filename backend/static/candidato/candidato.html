<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lumii • Área do Candidato</title>
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components/layout.css">
  <link rel="stylesheet" href="../css/components/buttons.css">
  <link rel="stylesheet" href="../css/components/forms.css">
  <link rel="stylesheet" href="../css/pages/candidato.css">
  
</head>
<body>

  <nav class="topnav">
    <button id="meuPerfilBtn"           class="btn">Meu Perfil</button>
    <button id="minhasVagasBtn"         class="btn">Minhas Vagas</button>
    <button id="meusEstudosBtn"         class="btn">Meus Estudos</button>
    <button id="meuDesenvolvimentoBtn"  class="btn" type="button">Meu Desenvolvimento</button>
    <button id="curriculoBtn"           class="btn">Currículo</button>
    <button id="logoutBtn"              class="btn">Sair</button>
  </nav>

  <main class="content" id="mainContent">
    <div id="mainContentArea">
      <h1>Carregando informações do candidato...</h1>
    </div>
  </main>

  <!-- MINHAS VAGAS -->
  <div id="vagasOverlay"></div>
  <div id="vagasPanel">
    <button id="closeVagasBtn">&times;</button>
    <h2>Minhas Vagas</h2>
    <div id="vagasContent">
      <div class="filters">
        <input id="filterTitle"   type="text"   placeholder="Filtrar por título…" />
        <input id="filterCompany" type="text"   placeholder="Filtrar por empresa…" />
        <input id="filterSalary"  type="number" placeholder="Salário mínimo" />
      </div>
      <div id="listaVagas"></div>
    </div>
  </div>

  <!-- MEU PERFIL / CRIADOR DE CURRÍCULO -->
  <div id="perfilOverlay"></div>
  <div id="perfilPanel">
    <button id="closePerfilBtn">&times;</button>
    <div id="perfilContent">
      <main class="container-principal">
        <div class="coluna coluna-esquerda">
          <h1>Criador de Currículo</h1>
          <form id="form-curriculo">
            <!-- campos pessoais, resumo, experiências, formação, habilidades -->
            <h2>Dados Pessoais</h2>
            <input type="text" name="nome" placeholder="Nome Completo" required>
            <input type="email" name="email" placeholder="Seu E-mail" required>
            <input type="tel" name="telefone" placeholder="Telefone / WhatsApp">
            <input type="text" name="linkedin" placeholder="URL do LinkedIn">
            <input type="text" name="portfolio" placeholder="URL do Portfólio">

            <h2>Resumo Profissional</h2>
            <textarea name="resumo" placeholder="Um parágrafo sobre sua carreira"></textarea>

            <h2>Experiência Profissional</h2>
            <div id="experiencias-container"></div>
            <button type="button" id="add-experiencia">+ Adicionar Experiência</button>

            <h2>Formação Acadêmica</h2>
            <div id="formacao-container"></div>
            <button type="button" id="add-formacao">+ Adicionar Formação</button>

            <h2>Habilidades</h2>
            <textarea name="habilidades" placeholder="Liste suas habilidades, separadas por vírgula"></textarea>

            <button type="submit" class="botao-principal">Salvar Currículo</button>
          </form>
        </div>
        <div class="coluna coluna-direita">
          <h1>Sua Biografia</h1>
          <p>Escreva um texto autêntico sobre você. (Colar e Desfazer desativados)</p>
          <textarea id="bio-textarea"></textarea>
        </div>
      </main>
    </div>
  </div>

  <script src="../js/firebase-config.js?v=20250108"></script>
  <script src="../js/router.js?v=20250108"></script>
  <script src="../js/onboarding.js?v=20250108"></script>
  
  <!-- Router initialization -->
  <script>
    // Intercepta tentativas de abrir entrevistas.html em nova aba
    const originalWindowOpen = window.open;
    window.open = function(url, target, features) {
      if (url && url.includes('entrevistas.html')) {
        if (window.candidateRouter) {
          window.candidateRouter.navigateTo('/candidato/desenvolvimento');
        } else {
          setTimeout(() => {
            if (window.candidateRouter) {
              window.candidateRouter.navigateTo('/candidato/desenvolvimento');
            }
          }, 100);
        }
        return null;
      }
      return originalWindowOpen.call(this, url, target, features);
    };
    
    // Limpar qualquer método problemático que possa existir em cache
    if (window.candidateRouter && window.candidateRouter.handleDesenvolvimentoClick) {
      delete window.candidateRouter.handleDesenvolvimentoClick;
    }
    
    // Garantir que o router seja inicializado PRIMEIRO
    if (typeof CandidateRouter !== 'undefined' && !window.candidateRouter) {
      window.candidateRouter = new CandidateRouter();
    }
    
    // Força remoção de qualquer listener problemático
    setTimeout(() => {
      const devBtn = document.getElementById('meuDesenvolvimentoBtn');
      if (devBtn && window.candidateRouter) {
        window.candidateRouter.removeAllListeners();
        window.candidateRouter.setupNavigation();
      }
    }, 500);
  </script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signOut }    from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, query, where, getDocs }
      from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // Configuração Firebase dinâmica
    const firebaseConfig = await loadFirebaseConfig();
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    
    // Torna o db disponível globalmente para o router
    window.db = db;

    // Inicializa o router
    window.candidateRouter = new CandidateRouter();

    // Inicializa o sistema de onboarding após um delay
    setTimeout(() => {
      const email = localStorage.getItem('candidateEmail');
      if (email && !window.candidateOnboarding) {
        // Initializing onboarding
        window.candidateOnboarding = new CandidateOnboarding();
      } else if (window.candidateOnboarding) {
        // Onboarding already initialized
      }
    }, 1500);

    // Função para recarregar perfil principal (agora redireciona para dashboard)
    window.loadMainProfile = function() {
      window.candidateRouter.navigateTo('/candidato');
    };

    async function loadMainProfile() {
      const mainContent = document.getElementById('mainContentArea');
      const email = localStorage.getItem('candidateEmail');
      
      if (!email) {
        window.location.href = '/index.html';
        return;
      }
      
      try {
        const perfilRef = collection(db, 'profiles');
        const perfilQ   = query(perfilRef, where('email', '==', email));
        const snap      = await getDocs(perfilQ);
        if (snap.empty) {
          mainContent.innerHTML = '<h1>Erro: perfil não encontrado.</h1>';
        } else {
          const d = snap.docs[0].data();
          mainContent.innerHTML = `
            <h1>Olá, ${d.full_name}!</h1>
            <p><strong>E-mail:</strong> ${d.email}</p>
            <p><strong>CPF:</strong> ${d.cpf||'–'}</p>
            <p><strong>Data de nascimento:</strong> ${d.birth_date||'–'}</p>
            <p><strong>Cidade:</strong> ${d.city||'–'} — <strong>Estado:</strong> ${d.state||'–'}</p>
          `;
        }
      } catch {
        mainContent.innerHTML = '<h1>Erro ao carregar perfil.</h1>';
      }
    }

    
    // Event listener para o botão de ajuda (removido pois o botão não existe mais)

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOut(auth)
        .then(() => {
          localStorage.removeItem('candidateEmail');
          window.location.href = '/index.html';
        })
        .catch(console.error);
    });

    // Variáveis globais para as vagas
    window.allVagas = [];
    window.appliedVagaIds = new Set();
    window.userId = sessionStorage.getItem('userId')
      || `user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
    sessionStorage.setItem('userId', window.userId);
    
    // Função para carregar candidaturas aplicadas
    async function loadAppliedJobs() {
      const candidateEmail = localStorage.getItem('candidateEmail');
      if (!candidateEmail) return;
      
      try {
        // Carrega candidaturas da coleção 'candidaturas-realizadas'
        const candidaturasQuery = query(
          collection(db, 'candidaturas-realizadas'),
          where('userEmail', '==', candidateEmail)
        );
        const candidaturasSnap = await getDocs(candidaturasQuery);
        
        candidaturasSnap.docs.forEach(doc => {
          const candidatura = doc.data();
          if (candidatura.vagaId) {
            appliedVagaIds.add(candidatura.vagaId);
          }
        });
        
        // Applied jobs loaded
      } catch (error) {
        console.error('❌ Erro ao carregar candidaturas aplicadas:', error);
      }
    }

    // Função para carregar vagas na seção interna
    window.loadVagasInterna = async function() {
      const listaVagasEl = document.getElementById('listaVagas');
      listaVagasEl.innerHTML = '<p style="text-align:center;color:#CCC;">Carregando vagas...</p>';

      // Carrega candidaturas aplicadas antes de renderizar vagas
      await loadAppliedJobs();

      try {
        const vagasSnap = await getDocs(collection(db, 'vagas'));
        const rawVagas = vagasSnap.docs.map(doc => ({
          ...doc.data(),
          docId: doc.id
        }));

        const emails = [...new Set(rawVagas.map(v => v.companyEmail).filter(Boolean))];
        const batches = [];
        for (let i = 0; i < emails.length; i += 10)
          batches.push(emails.slice(i, i + 10));

        const perfilMap = new Map();
        for (const batch of batches) {
          const q = query(collection(db, 'profiles'), where('email','in',batch));
          const snap = await getDocs(q);
          snap.docs.forEach(p => {
            perfilMap.set(p.data().email, p.data().full_name);
          });
        }

        allVagas = rawVagas.map(v => ({
          id: v.id,
          title: v.title,
          description: v.description,
          salary: v.salary,
          companyEmail: v.companyEmail,
          companyName: perfilMap.get(v.companyEmail) || v.companyEmail || 'Empresa não informada'
        }));

        renderVagasInternas(allVagas);
      } catch (error) {
        listaVagasEl.innerHTML = '<p style="text-align:center;color:#f00;">Erro ao carregar vagas.</p>';
        console.error(error);
      }
    }
    
    // Função para renderizar vagas na seção interna
    function renderVagasInternas(vagas) {
      const listaVagasEl = document.getElementById('listaVagas');
      listaVagasEl.innerHTML = '';
      
      if (!vagas.length) {
        listaVagasEl.innerHTML = '<p style="text-align:center;color:#CCC;">Nenhuma vaga encontrada.</p>';
        return;
      }
      
      vagas.forEach(v => {
        const isApp = appliedVagaIds.has(v.id);
        const cls = isApp ? 'btn-candidate btn-applied' : 'btn-candidate';
        const txt = isApp ? 'Candidatura Aplicada' : 'Candidatar-se';
        const href = isApp ? '#' : `candidatura.html?vagaId=${encodeURIComponent(v.id)}`;
        
        const div = document.createElement('div');
        div.className = 'vaga-item';
        div.style.cssText = `
          background: rgba(255,255,255,0.05);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 12px;
          padding: 1rem;
          display: grid;
          grid-template-columns: 1fr auto;
          gap: 1rem;
          margin-bottom: 1rem;
        `;
        
        div.innerHTML = `
          <div class="vaga-info">
            <h3 style="margin-bottom: 0.5rem; color: #FFF; font-size: 1.2rem;">${v.title}</h3>
            <p style="margin: 0.25rem 0; color: #CCC; font-size: 0.9rem;"><strong>Empresa:</strong> ${v.companyName}</p>
            <p style="margin: 0.25rem 0; color: #CCC; font-size: 0.9rem;"><strong>Salário:</strong> R$ ${typeof v.salary==='number'
              ? v.salary.toLocaleString('pt-BR',{minimumFractionDigits:2})
              : '-'
            }</p>
            <p style="margin: 0.25rem 0; color: #CCC; font-size: 0.9rem;">${v.description}</p>
          </div>
          <div class="vaga-actions">
            <a href="${href}" class="${cls}" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; background: ${isApp ? '#444' : '#39ff14'}; color: ${isApp ? '#888' : '#0A0A0A'}; font-weight: 600; cursor: ${isApp ? 'not-allowed' : 'pointer'}; text-decoration: none; transition: opacity .3s; display: inline-block;">${txt}</a>
          </div>
        `;
        
        listaVagasEl.appendChild(div);
        
        if (!isApp) {
          div.querySelector('a').addEventListener('click', () => {
            localStorage.setItem('vagaId', v.id);
            localStorage.setItem('companyEmail', v.companyEmail);
            const candidateEmail = localStorage.getItem('candidateEmail') || 'desconhecido';
            localStorage.setItem('userEmail', candidateEmail);
            
            // Adiciona listener para quando a página retornar
            window.addEventListener('focus', () => {
              // Recarrega as candidaturas quando a página ganha foco novamente
              setTimeout(() => {
                loadVagasInterna();
              }, 1000);
            }, { once: true });
          });
        }
      });
    }
    
    // Função global para marcar candidatura realizada
    window.markAsApplied = function(vagaId) {
      if (vagaId) {
        appliedVagaIds.add(vagaId);
        // Job marked as applied
        // Recarrega as vagas para atualizar a interface
        if (window.loadVagasInterna) {
          loadVagasInterna();
        }
      }
    };

    // Função para configurar os filtros de vagas
    window.setupVagasFilters = function() {
      ['filterTitle','filterCompany','filterSalary'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', () => {
            const ft = document.getElementById('filterTitle')?.value.toLowerCase() || '';
            const fc = document.getElementById('filterCompany')?.value.toLowerCase() || '';
            const sv = parseFloat(document.getElementById('filterSalary')?.value || '0');
            
            const filt = allVagas.filter(v => {
              const mt = v.title?.toLowerCase().includes(ft);
              const mc = v.companyName?.toLowerCase().includes(fc);
              return mt && mc && (isNaN(sv) || v.salary >= sv);
            });
            renderVagasInternas(filt);
          });
        }
      });
    }

    // Função loadVagas() removida - agora usa loadVagasInterna()

    // Funções renderVagas() e filtros antigos removidos - agora usam as funções internas

    // As funções de navegação foram movidas para o router.js
    
    // Função para configurar os event listeners do formulário de perfil
    window.setupProfileFormListeners = function() {
      // Desativa colar/desfazer na bio
      const bioArea = document.getElementById('bio-textarea');
      if (bioArea) {
        bioArea.addEventListener('paste', e => { e.preventDefault(); alert('Colar não permitido.'); });
        bioArea.addEventListener('keydown', e => {
          if (e.ctrlKey && e.key.toLowerCase()==='z') {
            e.preventDefault();
            alert('Desfazer não permitido.');
          }
        });
      }
      
      // Campos dinâmicos
      const addExperienciaBtn = document.getElementById('add-experiencia');
      if (addExperienciaBtn) {
        addExperienciaBtn.addEventListener('click', () => {
          const container = document.getElementById('experiencias-container');
          const div = document.createElement('div');
          div.className = 'campo-grupo';
          div.innerHTML = `
            <input type="text" name="cargo" placeholder="Cargo" required>
            <input type="text" name="empresa" placeholder="Empresa" required>
            <label>Data de Início:</label><input type="month" name="data_inicio_exp" required>
            <label>Data de Fim:</label><input type="month" name="data_fim_exp">
            <textarea name="descricao_exp" placeholder="Descrição"></textarea>
          `;
          container.appendChild(div);
        });
      }
      
      const addFormacaoBtn = document.getElementById('add-formacao');
      if (addFormacaoBtn) {
        addFormacaoBtn.addEventListener('click', () => {
          const container = document.getElementById('formacao-container');
          const div = document.createElement('div');
          div.className = 'campo-grupo';
          div.innerHTML = `
            <input type="text" name="curso" placeholder="Curso" required>
            <input type="text" name="instituicao" placeholder="Instituição" required>
            <input type="number" name="ano_conclusao" placeholder="Ano" min="1950" max="2050" required>
          `;
          container.appendChild(div);
        });
      }
      
      // Formulário de currículo
      const formCurriculo = document.getElementById('form-curriculo');
      if (formCurriculo) {
        formCurriculo.addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const btn = form.querySelector('button[type="submit"]');
          btn.textContent = 'Salvando...';
          btn.disabled = true;

          const fd = new FormData(form);
          const cv = {
            nome: fd.get('nome'),
            email: fd.get('email'),
            telefone: fd.get('telefone'),
            linkedin: fd.get('linkedin'),
            portfolio: fd.get('portfolio'),
            resumo: fd.get('resumo'),
            habilidades: fd.get('habilidades').split(',').map(s=>s.trim()),
            experiencias: [],
            formacoes: [],
            criadoEm: firebase.firestore.FieldValue.serverTimestamp()
          };

          const cargos = fd.getAll('cargo');
          const empresas = fd.getAll('empresa');
          const inicios = fd.getAll('data_inicio_exp');
          const fins = fd.getAll('data_fim_exp');
          const descrs = fd.getAll('descricao_exp');
          cargos.forEach((c,i) => cv.experiencias.push({
            cargo: c,
            empresa: empresas[i],
            inicio: inicios[i],
            fim: fins[i] || 'Atual',
            descricao: descrs[i]
          }));

          const cursos = fd.getAll('curso');
          const insts = fd.getAll('instituicao');
          const anos = fd.getAll('ano_conclusao');
          cursos.forEach((c,i) => cv.formacoes.push({
            curso: c,
            instituicao: insts[i],
            ano_conclusao: anos[i]
          }));

          try {
            if (!window.dbCompat) {
              throw new Error('Firebase não inicializado');
            }
            const docRef = await window.dbCompat.collection('curriculo').add(cv);
            alert(`Currículo salvo com sucesso! ID: ${docRef.id}`);
            form.reset();
            document.getElementById('experiencias-container').innerHTML = '';
            document.getElementById('formacao-container').innerHTML = '';
          } catch (error) {
            alert('Erro ao salvar currículo.');
            console.error(error);
          } finally {
            btn.textContent = 'Salvar Currículo';
            btn.disabled = false;
          }
        });
      }
    }

    // Removido: event listeners antigos do bio (agora estão na função setupProfileFormListeners)

    // Removido: event listeners antigos dos campos dinâmicos (agora estão na função setupProfileFormListeners)

    // Event listeners removidos - agora são gerenciados pelo router.js

    // Função para carregar conteúdo de páginas como seções internas
    window.loadPageContent = async function loadPageContent(url, title) {
      const mainContent = document.getElementById('mainContentArea');
            
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Erro ${response.status}`);
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extrai apenas o conteúdo do body
        const bodyContent = doc.body.innerHTML;
        mainContent.innerHTML = `
          <div class="page-container">
            <div class="section-header">
              <h1>${title}</h1>
              </div>
            
            <div class="section-content">
              ${bodyContent}
            </div>
          </div>
        `;
        
        
        // Re-executa scripts se necessário
        const scripts = mainContent.querySelectorAll('script');
        scripts.forEach(script => {
          if (script.src) {
            const newScript = document.createElement('script');
            newScript.src = script.src;
            document.head.appendChild(newScript);
          } else if (script.textContent) {
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            document.head.appendChild(newScript);
          }
        });
        
      } catch (error) {
        mainContent.innerHTML = `
          <div class="page-container">
            <div class="section-header">
              <h1>Erro ao carregar ${title}</h1>
              </div>
            
            <div class="section-content">
              <p>Não foi possível carregar o conteúdo: ${error.message}</p>
            </div>
          </div>
        `;
        
      }
    }

  </script>

  <!-- Firebase compat para o form de currículo -->
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
  <script>
    // Inicialização assíncrona do Firebase compat
    loadFirebaseConfig().then(config => {
      const firebaseConfigCompat = {
        ...config,
        storageBucket: "mini-genio-c204d.appspot.com" // Override para compat
      };
      firebase.initializeApp(firebaseConfigCompat);
      window.dbCompat = firebase.firestore();
    });

    // Removido: form de currículo antigo (agora está na função setupProfileFormListeners)
  </script>

</body>
</html>
