<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lumii • Área do Candidato</title>
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components/layout.css">
  <link rel="stylesheet" href="../css/components/buttons.css">
  <link rel="stylesheet" href="../css/components/forms.css">
  <link rel="stylesheet" href="../css/pages/candidato.css">
  
</head>
<body>

  <nav class="topnav">
    <button id="meuPerfilBtn"           class="btn">Meu Perfil</button>
    <button id="minhasVagasBtn"         class="btn">Minhas Vagas</button>
    <button id="meusEstudosBtn"         class="btn">Meus Estudos</button>
    <button id="meuDesenvolvimentoBtn"  class="btn" type="button">Meu Desenvolvimento</button>
    <button id="curriculoBtn"           class="btn">Currículo</button>
    <button id="logoutBtn"              class="btn">Sair</button>
  </nav>

  <main class="content" id="mainContent">
    <div id="mainContentArea">
      <h1>Carregando informações do candidato...</h1>
    </div>
  </main>

  <!-- MINHAS VAGAS -->
  <div id="vagasOverlay"></div>
  <div id="vagasPanel">
    <button id="closeVagasBtn">&times;</button>
    <h2>Minhas Vagas</h2>
    <div id="vagasContent">
      <div class="filters">
        <input id="filterTitle"   type="text"   placeholder="Filtrar por título…" />
        <input id="filterCompany" type="text"   placeholder="Filtrar por empresa…" />
        <input id="filterSalary"  type="number" placeholder="Salário mínimo" />
      </div>
      <div id="listaVagas"></div>
    </div>
  </div>

  <!-- MEU PERFIL / CRIADOR DE CURRÍCULO -->
  <div id="perfilOverlay"></div>
  <div id="perfilPanel">
    <button id="closePerfilBtn">&times;</button>
    <div id="perfilContent">
      <main class="container-principal">
        <div class="coluna coluna-esquerda">
          <h1>Criador de Currículo</h1>
          <form id="form-curriculo">
            <!-- campos pessoais, resumo, experiências, formação, habilidades -->
            <h2>Dados Pessoais</h2>
            <input type="text" name="nome" placeholder="Nome Completo" required>
            <input type="email" name="email" placeholder="Seu E-mail" required>
            <input type="tel" name="telefone" placeholder="Telefone / WhatsApp">
            <input type="text" name="linkedin" placeholder="URL do LinkedIn">
            <input type="text" name="portfolio" placeholder="URL do Portfólio">

            <h2>Resumo Profissional</h2>
            <textarea name="resumo" placeholder="Um parágrafo sobre sua carreira"></textarea>

            <h2>Experiência Profissional</h2>
            <div id="experiencias-container"></div>
            <button type="button" id="add-experiencia">+ Adicionar Experiência</button>

            <h2>Formação Acadêmica</h2>
            <div id="formacao-container"></div>
            <button type="button" id="add-formacao">+ Adicionar Formação</button>

            <h2>Habilidades</h2>
            <textarea name="habilidades" placeholder="Liste suas habilidades, separadas por vírgula"></textarea>

            <button type="submit" class="botao-principal">Salvar Currículo</button>
          </form>
        </div>
        <div class="coluna coluna-direita">
          <h1>Sua Biografia</h1>
          <p>Escreva um texto autêntico sobre você. (Colar e Desfazer desativados)</p>
          <textarea id="bio-textarea"></textarea>
        </div>
      </main>
    </div>
  </div>

  <script src="../js/firebase-config.js?v=20250108"></script>
  <script src="../js/router.js?v=20250108"></script>
  <script src="../js/onboarding.js?v=20250108"></script>
  
  <!-- Router initialization -->
  <script>
    // Intercepta tentativas de abrir entrevistas.html em nova aba
    const originalWindowOpen = window.open;
    window.open = function(url, target, features) {
      if (url && url.includes('entrevistas.html')) {
        if (window.candidateRouter) {
          window.candidateRouter.navigateTo('/candidato/desenvolvimento');
        } else {
          setTimeout(() => {
            if (window.candidateRouter) {
              window.candidateRouter.navigateTo('/candidato/desenvolvimento');
            }
          }, 100);
        }
        return null;
      }
      return originalWindowOpen.call(this, url, target, features);
    };
    
    // Limpar qualquer método problemático que possa existir em cache
    if (window.candidateRouter && window.candidateRouter.handleDesenvolvimentoClick) {
      delete window.candidateRouter.handleDesenvolvimentoClick;
    }
    
    // Garantir que o router seja inicializado PRIMEIRO
    if (typeof CandidateRouter !== 'undefined' && !window.candidateRouter) {
      window.candidateRouter = new CandidateRouter();
    }
    
    // Força remoção de qualquer listener problemático
    setTimeout(() => {
      const devBtn = document.getElementById('meuDesenvolvimentoBtn');
      if (devBtn && window.candidateRouter) {
        window.candidateRouter.removeAllListeners();
        window.candidateRouter.setupNavigation();
      }
    }, 500);
  </script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signOut }    from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, query, where, getDocs }
      from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // Configuração Firebase dinâmica
    const firebaseConfig = await loadFirebaseConfig();
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    
    // Torna o db disponível globalmente para o router
    window.db = db;

    // Inicializa o router
    window.candidateRouter = new CandidateRouter();

    // Inicializa o sistema de onboarding após um delay
    setTimeout(() => {
      const email = localStorage.getItem('candidateEmail');
      if (email && !window.candidateOnboarding) {
        // Initializing onboarding
        window.candidateOnboarding = new CandidateOnboarding();
      } else if (window.candidateOnboarding) {
        // Onboarding already initialized
      }
    }, 1500);

    // Função para recarregar perfil principal (agora redireciona para dashboard)
    window.loadMainProfile = function() {
      window.candidateRouter.navigateTo('/candidato');
    };

    async function loadMainProfile() {
      const mainContent = document.getElementById('mainContentArea');
      const email = localStorage.getItem('candidateEmail');
      
      if (!email) {
        window.location.href = '/index.html';
        return;
      }
      
      try {
        const perfilRef = collection(db, 'profiles');
        const perfilQ   = query(perfilRef, where('email', '==', email));
        const snap      = await getDocs(perfilQ);
        if (snap.empty) {
          mainContent.innerHTML = '<h1>Erro: perfil não encontrado.</h1>';
        } else {
          const d = snap.docs[0].data();
          mainContent.innerHTML = `
            <h1>Olá, ${d.full_name}!</h1>
            <p><strong>E-mail:</strong> ${d.email}</p>
            <p><strong>CPF:</strong> ${d.cpf||'–'}</p>
            <p><strong>Data de nascimento:</strong> ${d.birth_date||'–'}</p>
            <p><strong>Cidade:</strong> ${d.city||'–'} — <strong>Estado:</strong> ${d.state||'–'}</p>
          `;
        }
      } catch {
        mainContent.innerHTML = '<h1>Erro ao carregar perfil.</h1>';
      }
    }

    
    // Event listener para o botão de ajuda (removido pois o botão não existe mais)

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOut(auth)
        .then(() => {
          localStorage.removeItem('candidateEmail');
          window.location.href = '/index.html';
        })
        .catch(console.error);
    });

    // Variáveis globais para as vagas
    window.allVagas = [];
    window.appliedVagaIds = new Set();
    window.userId = sessionStorage.getItem('userId')
      || `user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
    sessionStorage.setItem('userId', window.userId);
    
    // Função para carregar candidaturas aplicadas
    async function loadAppliedJobs() {
      const candidateEmail = localStorage.getItem('candidateEmail');
      if (!candidateEmail) return;
      
      try {
        // Carrega candidaturas da coleção 'candidaturas-realizadas'
        const candidaturasQuery = query(
          collection(db, 'candidaturas-realizadas'),
          where('userEmail', '==', candidateEmail)
        );
        const candidaturasSnap = await getDocs(candidaturasQuery);
        
        candidaturasSnap.docs.forEach(doc => {
          const candidatura = doc.data();
          if (candidatura.vagaId) {
            appliedVagaIds.add(candidatura.vagaId);
          }
        });
        
        // Applied jobs loaded
      } catch (error) {
        console.error('❌ Erro ao carregar candidaturas aplicadas:', error);
      }
    }

    // Função para carregar vagas na seção interna
    window.loadVagasInterna = async function() {
      const listaVagasEl = document.getElementById('listaVagas');
      listaVagasEl.innerHTML = '<p style="text-align:center;color:#CCC;">Carregando vagas...</p>';

      // Carrega candidaturas aplicadas antes de renderizar vagas
      await loadAppliedJobs();

      try {
        const vagasSnap = await getDocs(collection(db, 'vagas'));
        const rawVagas = vagasSnap.docs.map(doc => ({
          ...doc.data(),
          docId: doc.id
        }));

        const emails = [...new Set(rawVagas.map(v => v.companyEmail).filter(Boolean))];
        const batches = [];
        for (let i = 0; i < emails.length; i += 10)
          batches.push(emails.slice(i, i + 10));

        const perfilMap = new Map();
        for (const batch of batches) {
          const q = query(collection(db, 'profiles'), where('email','in',batch));
          const snap = await getDocs(q);
          snap.docs.forEach(p => {
            perfilMap.set(p.data().email, p.data().full_name);
          });
        }

        allVagas = rawVagas.map(v => ({
          id: v.id,
          title: v.title,
          description: v.description,
          salary: v.salary,
          companyEmail: v.companyEmail,
          companyName: perfilMap.get(v.companyEmail) || v.companyEmail || 'Empresa não informada'
        }));

        renderVagasInternas(allVagas);
      } catch (error) {
        listaVagasEl.innerHTML = '<p style="text-align:center;color:#f00;">Erro ao carregar vagas.</p>';
        console.error(error);
      }
    }
    
    // Função para renderizar vagas na seção interna
    function renderVagasInternas(vagas) {
      const listaVagasEl = document.getElementById('listaVagas');
      listaVagasEl.innerHTML = '';
      
      if (!vagas.length) {
        listaVagasEl.innerHTML = '<p style="text-align:center;color:#CCC;">Nenhuma vaga encontrada.</p>';
        return;
      }
      
      vagas.forEach(v => {
        const isApp = appliedVagaIds.has(v.id);
        
        const div = document.createElement('div');
        div.className = 'vaga-item';
        div.dataset.vagaId = v.id;
        div.style.cssText = `
          background: rgba(255,255,255,0.05);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 12px;
          padding: 1rem;
          margin-bottom: 1rem;
          cursor: pointer;
          transition: all 0.3s ease;
        `;
        
        div.innerHTML = `
          <div class="vaga-info">
            <h3 style="margin-bottom: 0.5rem; color: #FFF; font-size: 1.2rem;">${v.title}</h3>
            <p style="margin: 0.25rem 0; color: #CCC; font-size: 0.9rem;"><strong>Empresa:</strong> ${v.companyName}</p>
            <p style="margin: 0.25rem 0; color: #CCC; font-size: 0.9rem;"><strong>Salário:</strong> R$ ${typeof v.salary==='number'
              ? v.salary.toLocaleString('pt-BR',{minimumFractionDigits:2})
              : '-'
            }</p>
            <p style="margin: 0.25rem 0; color: #CCC; font-size: 0.9rem; line-height: 1.4;">${v.description}</p>
            ${isApp ? '<div style="margin-top: 0.5rem; color: #39ff14; font-size: 0.8rem; font-weight: 600;">✅ Candidatura Aplicada</div>' : ''}
          </div>
        `;
        
        // Adiciona evento de clique para mostrar detalhes
        div.addEventListener('click', () => {
          // Remove seleção anterior
          document.querySelectorAll('.vaga-item').forEach(item => {
            item.style.border = '1px solid rgba(255,255,255,0.2)';
          });
          
          // Marca como selecionada
          div.style.border = '2px solid #39ff14';
          
          // Carrega detalhes no painel direito
          showVagaDetails(v, isApp);
        });
        
        listaVagasEl.appendChild(div);
      });
    }
    
    // Função para mostrar detalhes da vaga no painel direito
    window.showVagaDetails = function(vaga, isApplied) {
      const detailsPanel = document.getElementById('vagaDetailsPanel');
      
      detailsPanel.innerHTML = `
        <div class="vaga-header" style="margin-bottom: 1.5rem;">
          <h2 style="color: #FFF; margin-bottom: 0.5rem; font-size: 1.4rem;">${vaga.title}</h2>
          <p style="color: #CCC; margin-bottom: 0.25rem;"><strong>Empresa:</strong> ${vaga.companyName}</p>
          <p style="color: #CCC; margin-bottom: 1rem;"><strong>Salário:</strong> R$ ${typeof vaga.salary==='number'
            ? vaga.salary.toLocaleString('pt-BR',{minimumFractionDigits:2})
            : '-'
          }</p>
        </div>
        
        
        <div class="candidatura-actions">
          ${isApplied ? 
            '<div style="text-align: center; padding: 1rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px; border: 1px solid rgba(57, 255, 20, 0.3);"><p style="color: #39ff14; font-weight: 600;">✅ Você já se candidatou para esta vaga</p></div>' 
            : 
            `<div class="candidatura-buttons">
              <div id="candidaturaButtons" style="margin-bottom: 1rem;">
                <!-- Botões serão inseridos dinamicamente -->
              </div>
              <div id="candidaturaContent" style="margin-top: 1rem;"></div>
            </div>`
          }
        </div>
      `;
      
      if (!isApplied) {
        // Configura eventos dos botões de candidatura dinamicamente
        setTimeout(() => setupCandidaturaButtonsAsync(vaga), 300);
      }
    }
    
    // Função assíncrona para configurar botões de candidatura dinamicamente
    window.setupCandidaturaButtonsAsync = async function(vaga) {
      // Armazena dados da vaga no localStorage
      localStorage.setItem('vagaId', vaga.id);
      localStorage.setItem('companyEmail', vaga.companyEmail);
      const candidateEmail = localStorage.getItem('candidateEmail') || 'desconhecido';
      localStorage.setItem('userEmail', candidateEmail);
      
      const candidaturaButtons = document.getElementById('candidaturaButtons');
      const candidaturaContent = document.getElementById('candidaturaContent');
      
      if (!candidaturaButtons || !candidateEmail) return;
      
      try {
        // Verifica respostas já salvas
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        const respostasRef = doc(window.db, 'respostas-valores-dinamicas-trilhas', candidateEmail);
        const respostasSnap = await getDoc(respostasRef);
        const savedData = respostasSnap.exists() ? respostasSnap.data() : {};
        
        let buttonsHTML = '';
        let firstAvailableStep = null;
        
        // Verifica Valores
        if (!savedData.respostasValores?.length) {
          const valoresExistem = await checkValoresExistem(vaga.companyEmail);
          if (valoresExistem) {
            buttonsHTML += '<button id="btnValoresCandidatura" class="btn-candidatura" style="background: rgba(57, 255, 20, 0.8); color: #0A0A0A; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin: 0.5rem 0.5rem 0.5rem 0; transition: all 0.3s;">Valores</button>';
            if (!firstAvailableStep) firstAvailableStep = 'valores';
          }
        }
        
        // Verifica Dinâmicas
        if (!savedData.respostasDinamicas?.length) {
          const dinamicasExistem = await checkDinamicasExistem(vaga.companyEmail);
          if (dinamicasExistem) {
            buttonsHTML += '<button id="btnDinamicasCandidatura" class="btn-candidatura" style="background: rgba(57, 255, 20, 0.8); color: #0A0A0A; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin: 0.5rem 0.5rem 0.5rem 0; transition: all 0.3s;">Dinâmicas</button>';
            if (!firstAvailableStep) firstAvailableStep = 'dinamicas';
          }
        }
        
        // Verifica Trilhas
        if (!savedData.respostasTrilhas || !Object.keys(savedData.respostasTrilhas).length) {
          const trilhasExistem = await checkTrilhasExistem();
          if (trilhasExistem) {
            buttonsHTML += '<button id="btnTrilhasCandidatura" class="btn-candidatura" style="background: rgba(57, 255, 20, 0.8); color: #0A0A0A; padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin: 0.5rem 0.5rem 0.5rem 0; transition: all 0.3s;">Trilhas</button>';
            if (!firstAvailableStep) firstAvailableStep = 'trilhas';
          }
        }
        
        // Insere os botões ou mensagem de conclusão
        if (buttonsHTML) {
          candidaturaButtons.innerHTML = buttonsHTML;
          
          // Configura event listeners
          const btnValores = document.getElementById('btnValoresCandidatura');
          const btnDinamicas = document.getElementById('btnDinamicasCandidatura');
          const btnTrilhas = document.getElementById('btnTrilhasCandidatura');
          
          if (btnValores) {
            btnValores.addEventListener('click', () => loadCandidaturaStep('valores', candidaturaContent));
          }
          if (btnDinamicas) {
            btnDinamicas.addEventListener('click', () => loadCandidaturaStep('dinamicas', candidaturaContent));
          }
          if (btnTrilhas) {
            btnTrilhas.addEventListener('click', () => loadCandidaturaStep('trilhas', candidaturaContent));
          }
          
          // Auto-carrega a primeira etapa disponível
          if (firstAvailableStep) {
            setTimeout(() => {
              loadCandidaturaStep(firstAvailableStep, candidaturaContent);
              const btnId = `btn${firstAvailableStep.charAt(0).toUpperCase() + firstAvailableStep.slice(1)}Candidatura`;
              const btn = document.getElementById(btnId);
              if (btn) {
                btn.style.background = 'rgba(57, 255, 20, 1)';
                btn.style.transform = 'scale(1.05)';
              }
            }, 200);
          }
        } else {
          // Todas as etapas foram respondidas ou não há etapas disponíveis
          candidaturaButtons.innerHTML = `
            <div style="text-align: center; padding: 1rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px; border: 1px solid rgba(57, 255, 20, 0.3);">
              <p style="color: #39ff14; font-weight: 600;">✅ Todas as etapas de candidatura foram concluídas</p>
            </div>
          `;
        }
        
      } catch (error) {
        candidaturaButtons.innerHTML = '<p style="color: #ff6b6b; text-align: center;">Erro ao carregar etapas de candidatura</p>';
      }
    }
    
    // Função para verificar se valores existem para a empresa
    window.checkValoresExistem = async function(companyEmail) {
      try {
        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        const docId = companyEmail.replace(/[@.]/g,'_');
        const snap = await getDocs(query(collection(window.db,'valores_unicos'), where('__name__','==',docId)));
        return !snap.empty && snap.docs[0].data().valores?.length > 0;
      } catch (error) {
        return false;
      }
    }
    
    // Função para verificar se dinâmicas existem para a empresa
    window.checkDinamicasExistem = async function(companyEmail) {
      try {
        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        const docId = companyEmail.replace(/[@.]/g,'_');
        const snap = await getDocs(query(collection(window.db,'dinamicas_unicas'), where('__name__','==',docId)));
        return !snap.empty && snap.docs[0].data().dinamicas?.length > 0;
      } catch (error) {
        return false;
      }
    }
    
    // Função para verificar se trilhas existem
    window.checkTrilhasExistem = async function() {
      try {
        const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        const snap = await getDocs(collection(window.db,'trilhas'));
        return !snap.empty;
      } catch (error) {
        return false;
      }
    }
    
    // Função para carregar etapa de candidatura
    window.loadCandidaturaStep = async function(step, container) {
      const vagaId = localStorage.getItem('vagaId');
      const companyEmail = localStorage.getItem('companyEmail');
      const userEmail = localStorage.getItem('candidateEmail');
      
      if (!userEmail) {
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(255,0,0,0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(255,0,0,0.3);">
            <p style="color: #ff6b6b;">Erro: e-mail do usuário não encontrado.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 1rem;">
          <p style="color: #CCC;">Carregando ${step}...</p>
        </div>
      `;

      try {
        // Verifica se já respondeu esta etapa
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        const respostasRef = doc(window.db, 'respostas-valores-dinamicas-trilhas', userEmail);
        const respostasSnap = await getDoc(respostasRef);
        const savedData = respostasSnap.exists() ? respostasSnap.data() : {};

        if (step === 'valores') {
          await loadValoresStep(container, companyEmail, savedData);
        } else if (step === 'dinamicas') {
          await loadDinamicasStep(container, companyEmail, savedData);
        } else if (step === 'trilhas') {
          await loadTrilhasStep(container, savedData);
        }
      } catch (error) {
        console.error(`Erro ao carregar ${step}:`, error);
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(255,0,0,0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(255,0,0,0.3);">
            <p style="color: #ff6b6b;">Erro ao carregar ${step}. Tente novamente.</p>
          </div>
        `;
      }
    }

    // Função para carregar etapa de valores
    window.loadValoresStep = async function(container, companyEmail, savedData) {
      if (savedData.respostasValores?.length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(57, 255, 20, 0.3);">
            <p style="color: #39ff14; font-weight: 600;">✅ Você já respondeu esta etapa.</p>
          </div>
        `;
        return;
      }

      const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
      const docId = companyEmail.replace(/[@.]/g,'_');
      const snap = await getDocs(query(collection(window.db,'valores_unicos'), where('__name__','==',docId)));
      
      if (snap.empty) {
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(255,255,0,0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(255,255,0,0.3);">
            <p style="color: #ffeb3b;">Nenhum valor encontrado para esta empresa.</p>
          </div>
        `;
        return;
      }

      const valores = snap.docs[0].data().valores || [];
      
      let html = '<div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; margin-top: 1rem;"><h4 style="color: #FFF; margin-bottom: 1rem;">Valores da Empresa</h4>';
      
      valores.forEach((v, i) => {
        html += `
          <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 6px;">
            <strong style="color: #39ff14;">${v.nomeValor}:</strong>
            <p style="color: #DDD; margin: 0.5rem 0; font-size: 0.9rem;">${v.explicacao}</p>
            <textarea id="val_${i}" placeholder="Sua resposta..." style="width: 100%; min-height: 80px; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: #FFF; font-family: inherit; resize: vertical;"></textarea>
          </div>
        `;
      });
      
      html += '<button id="btnSalvarValoresInline" style="width: 100%; padding: 0.8rem; margin-top: 1rem; background: #39ff14; color: #0A0A0A; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Salvar Respostas dos Valores</button></div>';
      
      container.innerHTML = html;
      
      // Configura evento do botão salvar
      document.getElementById('btnSalvarValoresInline').addEventListener('click', () => saveValoresInline(valores, container));
    }

    // Função para salvar valores inline
    window.saveValoresInline = async function(valores, container) {
      const respostas = [];
      valores.forEach((v, i) => {
        const textarea = document.getElementById(`val_${i}`);
        const texto = textarea.value.trim();
        if (texto) {
          respostas.push({ nomeValor: v.nomeValor, resposta: texto });
        }
      });

      if (!respostas.length) {
        alert('Preencha ao menos uma resposta.');
        return;
      }

      try {
        const { doc, setDoc, addDoc, collection, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        
        const vagaId = localStorage.getItem('vagaId');
        const companyEmail = localStorage.getItem('companyEmail');
        const userEmail = localStorage.getItem('candidateEmail');
        
        const respostasRef = doc(window.db, 'respostas-valores-dinamicas-trilhas', userEmail);
        
        await setDoc(respostasRef, {
          companyEmail, vagaId, userEmail,
          respostasValores: respostas, 
          timestamp: serverTimestamp()
        }, { merge: true });
        
        // Registra candidatura realizada
        await addDoc(collection(window.db, 'candidaturas-realizadas'), {
          vagaId: vagaId,
          userEmail: userEmail,
          companyEmail: companyEmail,
          status: 'candidatura_feita',
          timestamp: serverTimestamp()
        });

        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(57, 255, 20, 0.3);">
            <p style="color: #39ff14; font-weight: 600;">✅ Respostas dos valores salvas com sucesso!</p>
          </div>
        `;
        
        // Recarrega a lista de vagas para atualizar status
        if (window.loadVagasInterna) {
          window.loadVagasInterna();
        }
      } catch (error) {
        console.error('Erro ao salvar valores:', error);
        alert('Erro ao salvar respostas. Tente novamente.');
      }
    }

    // Função para carregar etapa de dinâmicas
    window.loadDinamicasStep = async function(container, companyEmail, savedData) {
      if (savedData.respostasDinamicas?.length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(57, 255, 20, 0.3);">
            <p style="color: #39ff14; font-weight: 600;">✅ Você já respondeu esta etapa.</p>
          </div>
        `;
        return;
      }

      const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
      const docId = companyEmail.replace(/[@.]/g,'_');
      const snap = await getDocs(query(collection(window.db,'dinamicas_unicas'), where('__name__','==',docId)));
      
      if (snap.empty) {
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(255,255,0,0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(255,255,0,0.3);">
            <p style="color: #ffeb3b;">Nenhuma dinâmica encontrada para esta empresa.</p>
          </div>
        `;
        return;
      }

      const dinamicas = snap.docs[0].data().dinamicas || [];
      
      let html = '<div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; margin-top: 1rem;"><h4 style="color: #FFF; margin-bottom: 1rem;">Dinâmicas Propostas</h4>';
      
      dinamicas.forEach((d, i) => {
        html += `
          <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 6px;">
            <strong style="color: #39ff14;">${d.nomeDinamica}:</strong>
            <p style="color: #DDD; margin: 0.5rem 0; font-size: 0.9rem;">${d.explicacao}</p>
            <textarea id="din_${i}" placeholder="Sua resposta..." style="width: 100%; min-height: 80px; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: #FFF; font-family: inherit; resize: vertical;"></textarea>
          </div>
        `;
      });
      
      html += '<button id="btnSalvarDinamicasInline" style="width: 100%; padding: 0.8rem; margin-top: 1rem; background: #39ff14; color: #0A0A0A; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Salvar Respostas das Dinâmicas</button></div>';
      
      container.innerHTML = html;
      
      // Configura evento do botão salvar
      document.getElementById('btnSalvarDinamicasInline').addEventListener('click', () => saveDinamicasInline(dinamicas, container));
    }

    // Função para salvar dinâmicas inline
    window.saveDinamicasInline = async function(dinamicas, container) {
      const respostas = [];
      dinamicas.forEach((d, i) => {
        const textarea = document.getElementById(`din_${i}`);
        const texto = textarea.value.trim();
        if (texto) {
          respostas.push({ nomeDinamica: d.nomeDinamica, resposta: texto });
        }
      });

      if (!respostas.length) {
        alert('Preencha ao menos uma resposta.');
        return;
      }

      try {
        const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        
        const vagaId = localStorage.getItem('vagaId');
        const companyEmail = localStorage.getItem('companyEmail');
        const userEmail = localStorage.getItem('candidateEmail');
        
        const respostasRef = doc(window.db, 'respostas-valores-dinamicas-trilhas', userEmail);
        
        await setDoc(respostasRef, {
          companyEmail, vagaId, userEmail,
          respostasDinamicas: respostas, 
          timestamp: serverTimestamp()
        }, { merge: true });

        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(57, 255, 20, 0.3);">
            <p style="color: #39ff14; font-weight: 600;">✅ Respostas das dinâmicas salvas com sucesso!</p>
          </div>
        `;
        
        // Recarrega a lista de vagas para atualizar status
        if (window.loadVagasInterna) {
          window.loadVagasInterna();
        }
      } catch (error) {
        console.error('Erro ao salvar dinâmicas:', error);
        alert('Erro ao salvar respostas. Tente novamente.');
      }
    }

    // Função para carregar etapa de trilhas
    window.loadTrilhasStep = async function(container, savedData) {
      if (savedData.respostasTrilhas && Object.keys(savedData.respostasTrilhas).length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(57, 255, 20, 0.3);">
            <p style="color: #39ff14; font-weight: 600;">✅ Você já respondeu esta etapa.</p>
          </div>
        `;
        return;
      }

      const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
      const snap = await getDocs(collection(window.db,'trilhas'));
      
      if (snap.empty) {
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(255,255,0,0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(255,255,0,0.3);">
            <p style="color: #ffeb3b;">Nenhuma trilha encontrada.</p>
          </div>
        `;
        return;
      }

      let html = '<div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; margin-top: 1rem;"><h4 style="color: #FFF; margin-bottom: 1rem;">Trilha de Desafios</h4>';
      let idx = 0;
      
      snap.docs.forEach(doc => {
        const data = doc.data();
        Object.entries(data).forEach(([categoria, questoes]) => {
          html += `<h5 style="color: #39ff14; margin: 1.5rem 0 1rem; font-size: 1.1rem; border-bottom: 1px solid rgba(57, 255, 20, 0.3); padding-bottom: 0.5rem;">${categoria}</h5>`;
          
          questoes.forEach(questao => {
            html += `
              <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 6px;" data-cat="${categoria}" data-questao="${encodeURIComponent(questao)}">
                <p style="color: #DDD; margin-bottom: 0.5rem; font-style: italic;">${questao}</p>
                <textarea id="tri_${idx}" placeholder="Sua resposta..." style="width: 100%; min-height: 80px; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: #FFF; font-family: inherit; resize: vertical;"></textarea>
              </div>
            `;
            idx++;
          });
        });
      });
      
      html += '<button id="btnSalvarTrilhasInline" style="width: 100%; padding: 0.8rem; margin-top: 1rem; background: #39ff14; color: #0A0A0A; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Salvar Respostas da Trilha</button></div>';
      
      container.innerHTML = html;
      
      // Configura evento do botão salvar
      document.getElementById('btnSalvarTrilhasInline').addEventListener('click', () => saveTrilhasInline(container));
    }

    // Função para salvar trilhas inline
    window.saveTrilhasInline = async function(container) {
      const agrupadas = {};
      let temResposta = false;
      
      container.querySelectorAll('[data-cat]').forEach((div, i) => {
        const categoria = div.dataset.cat;
        const questao = decodeURIComponent(div.dataset.questao);
        const textarea = document.getElementById(`tri_${i}`);
        const texto = textarea.value.trim();
        
        if (texto) {
          temResposta = true;
          if (!agrupadas[categoria]) agrupadas[categoria] = [];
          agrupadas[categoria].push({ questao, resposta: texto });
        }
      });

      if (!temResposta) {
        alert('Preencha ao menos uma resposta.');
        return;
      }

      try {
        const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        
        const vagaId = localStorage.getItem('vagaId');
        const companyEmail = localStorage.getItem('companyEmail');
        const userEmail = localStorage.getItem('candidateEmail');
        
        const respostasRef = doc(window.db, 'respostas-valores-dinamicas-trilhas', userEmail);
        
        await setDoc(respostasRef, {
          companyEmail, vagaId, userEmail,
          respostasTrilhas: agrupadas, 
          timestamp: serverTimestamp()
        }, { merge: true });

        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(57, 255, 20, 0.3);">
            <p style="color: #39ff14; font-weight: 600;">✅ Respostas da trilha salvas com sucesso!</p>
          </div>
        `;
        
        // Recarrega a lista de vagas para atualizar status
        if (window.loadVagasInterna) {
          window.loadVagasInterna();
        }
      } catch (error) {
        console.error('Erro ao salvar trilhas:', error);
        alert('Erro ao salvar respostas. Tente novamente.');
      }
    }

    // Função global para marcar candidatura realizada
    window.markAsApplied = function(vagaId) {
      if (vagaId) {
        appliedVagaIds.add(vagaId);
        // Job marked as applied
        // Recarrega as vagas para atualizar a interface
        if (window.loadVagasInterna) {
          loadVagasInterna();
        }
      }
    };

    // Função para configurar os filtros de vagas
    window.setupVagasFilters = function() {
      ['filterTitle','filterCompany','filterSalary'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', () => {
            const ft = document.getElementById('filterTitle')?.value.toLowerCase() || '';
            const fc = document.getElementById('filterCompany')?.value.toLowerCase() || '';
            const sv = parseFloat(document.getElementById('filterSalary')?.value || '0');
            
            const filt = allVagas.filter(v => {
              const mt = v.title?.toLowerCase().includes(ft);
              const mc = v.companyName?.toLowerCase().includes(fc);
              return mt && mc && (isNaN(sv) || v.salary >= sv);
            });
            renderVagasInternas(filt);
          });
        }
      });
    }

    // Função loadVagas() removida - agora usa loadVagasInterna()

    // Funções renderVagas() e filtros antigos removidos - agora usam as funções internas

    // As funções de navegação foram movidas para o router.js
    
    // Função para carregar dados existentes do currículo
    window.loadExistingCurriculo = async function() {
      const userEmail = localStorage.getItem('candidateEmail');
      if (!userEmail) return;
      
      try {
        // Importa as funções do Firebase v9 moderno
        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        
        // Busca currículos do usuário (sem ordenação para evitar índice)
        const curriculoQuery = query(
          collection(window.db, 'curriculo'), 
          where('email', '==', userEmail)
        );
        
        const snapshot = await getDocs(curriculoQuery);
        
        if (!snapshot.empty) {
          // Ordena manualmente pelo timestamp mais recente
          const curriculos = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          // Ordena por data de criação (mais recente primeiro)
          curriculos.sort((a, b) => {
            const dateA = a.criadoEm?.toDate?.() || a.criadoEm || new Date(0);
            const dateB = b.criadoEm?.toDate?.() || b.criadoEm || new Date(0);
            return dateB - dateA;
          });
          
          const curriculo = curriculos[0];
          
          // Preenche os campos básicos
          const form = document.getElementById('form-curriculo');
          if (form) {
            form.querySelector('input[name="nome"]').value = curriculo.nome || '';
            // Sempre usa o email do usuário logado, não o que está salvo no currículo
            form.querySelector('input[name="email"]').value = userEmail;
            form.querySelector('input[name="telefone"]').value = curriculo.telefone || '';
            form.querySelector('input[name="linkedin"]').value = curriculo.linkedin || '';
            form.querySelector('input[name="portfolio"]').value = curriculo.portfolio || '';
            form.querySelector('textarea[name="resumo"]').value = curriculo.resumo || '';
            form.querySelector('textarea[name="habilidades"]').value = (curriculo.habilidades || []).join(', ');
          }
          
          // Preenche experiências
          const expContainer = document.getElementById('experiencias-container');
          if (expContainer && curriculo.experiencias) {
            expContainer.innerHTML = '';
            curriculo.experiencias.forEach(exp => {
              const div = document.createElement('div');
              div.className = 'campo-grupo';
              div.innerHTML = `
                <input type="text" name="cargo" placeholder="Cargo" required value="${exp.cargo || ''}">
                <input type="text" name="empresa" placeholder="Empresa" required value="${exp.empresa || ''}">
                <label>Data de Início:</label><input type="month" name="data_inicio_exp" required value="${exp.inicio || ''}">
                <label>Data de Fim:</label><input type="month" name="data_fim_exp" value="${exp.fim !== 'Atual' ? exp.fim || '' : ''}">
                <textarea name="descricao_exp" placeholder="Descrição">${exp.descricao || ''}</textarea>
              `;
              expContainer.appendChild(div);
            });
          }
          
          // Preenche formações
          const formContainer = document.getElementById('formacao-container');
          if (formContainer && curriculo.formacoes) {
            formContainer.innerHTML = '';
            curriculo.formacoes.forEach(form => {
              const div = document.createElement('div');
              div.className = 'campo-grupo';
              div.innerHTML = `
                <input type="text" name="curso" placeholder="Curso" required value="${form.curso || ''}">
                <input type="text" name="instituicao" placeholder="Instituição" required value="${form.instituicao || ''}">
                <input type="number" name="ano_conclusao" placeholder="Ano" min="1950" max="2050" required value="${form.ano_conclusao || ''}">
              `;
              formContainer.appendChild(div);
            });
          }
        }
      } catch (error) {
        console.error('Erro ao carregar currículo existente:', error);
      }
    };

    // Função para configurar os event listeners do formulário de perfil
    window.setupProfileFormListeners = function() {
      // Desativa colar/desfazer na bio
      const bioArea = document.getElementById('bio-textarea');
      if (bioArea) {
        // Remove listeners existentes clonando elemento
        const newBioArea = bioArea.cloneNode(true);
        bioArea.parentNode.replaceChild(newBioArea, bioArea);
        
        newBioArea.addEventListener('paste', e => { e.preventDefault(); alert('Colar não permitido.'); });
        newBioArea.addEventListener('keydown', e => {
          if (e.ctrlKey && e.key.toLowerCase()==='z') {
            e.preventDefault();
            alert('Desfazer não permitido.');
          }
        });
      }
      
      // Campos dinâmicos - definir handlers como funções nomeadas para poder remover
      const addExperienciaHandler = () => {
        const container = document.getElementById('experiencias-container');
        if (container) {
          const div = document.createElement('div');
          div.className = 'campo-grupo';
          div.innerHTML = `
            <input type="text" name="cargo" placeholder="Cargo" required>
            <input type="text" name="empresa" placeholder="Empresa" required>
            <label>Data de Início:</label><input type="month" name="data_inicio_exp" required>
            <label>Data de Fim:</label><input type="month" name="data_fim_exp">
            <textarea name="descricao_exp" placeholder="Descrição"></textarea>
          `;
          container.appendChild(div);
        }
      };
      
      const addFormacaoHandler = () => {
        const container = document.getElementById('formacao-container');
        if (container) {
          const div = document.createElement('div');
          div.className = 'campo-grupo';
          div.innerHTML = `
            <input type="text" name="curso" placeholder="Curso" required>
            <input type="text" name="instituicao" placeholder="Instituição" required>
            <input type="number" name="ano_conclusao" placeholder="Ano" min="1950" max="2050" required>
          `;
          container.appendChild(div);
        }
      };
      
      // Campos dinâmicos
      const addExperienciaBtn = document.getElementById('add-experiencia');
      if (addExperienciaBtn) {
        // Remove listeners existentes clonando elemento
        const newExpBtn = addExperienciaBtn.cloneNode(true);
        addExperienciaBtn.parentNode.replaceChild(newExpBtn, addExperienciaBtn);
        newExpBtn.addEventListener('click', addExperienciaHandler);
      }
      
      const addFormacaoBtn = document.getElementById('add-formacao');
      if (addFormacaoBtn) {
        // Remove listeners existentes clonando elemento
        const newFormBtn = addFormacaoBtn.cloneNode(true);
        addFormacaoBtn.parentNode.replaceChild(newFormBtn, addFormacaoBtn);
        newFormBtn.addEventListener('click', addFormacaoHandler);
      }
      
      // Formulário de currículo
      const formCurriculo = document.getElementById('form-curriculo');
      if (formCurriculo) {
        // Remove listener existente clonando elemento  
        const newForm = formCurriculo.cloneNode(true);
        formCurriculo.parentNode.replaceChild(newForm, formCurriculo);
        
        // Reconfigurar botões internos do novo form clonado
        const newExpBtn = newForm.querySelector('#add-experiencia');
        const newFormBtn = newForm.querySelector('#add-formacao');
        
        if (newExpBtn) {
          newExpBtn.addEventListener('click', addExperienciaHandler);
        }
        
        if (newFormBtn) {
          newFormBtn.addEventListener('click', addFormacaoHandler);
        }
        
        newForm.addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const btn = form.querySelector('button[type="submit"]');
          btn.textContent = 'Salvando...';
          btn.disabled = true;

          const fd = new FormData(form);
          const cv = {
            nome: fd.get('nome'),
            email: fd.get('email'),
            telefone: fd.get('telefone'),
            linkedin: fd.get('linkedin'),
            portfolio: fd.get('portfolio'),
            resumo: fd.get('resumo'),
            habilidades: fd.get('habilidades').split(',').map(s=>s.trim()),
            experiencias: [],
            formacoes: [],
            criadoEm: null // Será definido antes de salvar
          };

          const cargos = fd.getAll('cargo');
          const empresas = fd.getAll('empresa');
          const inicios = fd.getAll('data_inicio_exp');
          const fins = fd.getAll('data_fim_exp');
          const descrs = fd.getAll('descricao_exp');
          cargos.forEach((c,i) => cv.experiencias.push({
            cargo: c,
            empresa: empresas[i],
            inicio: inicios[i],
            fim: fins[i] || 'Atual',
            descricao: descrs[i]
          }));

          const cursos = fd.getAll('curso');
          const insts = fd.getAll('instituicao');
          const anos = fd.getAll('ano_conclusao');
          cursos.forEach((c,i) => cv.formacoes.push({
            curso: c,
            instituicao: insts[i],
            ano_conclusao: anos[i]
          }));

          try {
            if (!window.db) {
              throw new Error('Firebase não inicializado');
            }
            
            // Importa as funções do Firebase v9 moderno
            const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
            
            // Atualiza o timestamp para usar a versão correta
            cv.criadoEm = serverTimestamp();
            
            const docRef = await addDoc(collection(window.db, 'curriculo'), cv);
            alert(`Currículo salvo com sucesso! ID: ${docRef.id}`);
            
            // Dados serão recarregados automaticamente quando usar "Melhorar com IA"
            
            // Não limpa o formulário - usuário pode querer fazer mais alterações
            // form.reset();
            // document.getElementById('experiencias-container').innerHTML = '';
            // document.getElementById('formacao-container').innerHTML = '';
          } catch (error) {
            alert('Erro ao salvar currículo.');
            console.error(error);
          } finally {
            btn.textContent = 'Salvar Currículo';
            btn.disabled = false;
          }
        });
      }
    }

    // Removido: event listeners antigos do bio (agora estão na função setupProfileFormListeners)

    // Removido: event listeners antigos dos campos dinâmicos (agora estão na função setupProfileFormListeners)

    // Event listeners removidos - agora são gerenciados pelo router.js

    // Função para carregar conteúdo de páginas como seções internas
    window.loadPageContent = async function loadPageContent(url, title) {
      const mainContent = document.getElementById('mainContentArea');
            
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Erro ${response.status}`);
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extrai apenas o conteúdo do body
        const bodyContent = doc.body.innerHTML;
        mainContent.innerHTML = `
          <div class="page-container">
            <div class="section-header">
              <h1>${title}</h1>
              </div>
            
            <div class="section-content">
              ${bodyContent}
            </div>
          </div>
        `;
        
        
        // Re-executa scripts se necessário
        const scripts = mainContent.querySelectorAll('script');
        scripts.forEach(script => {
          if (script.src) {
            const newScript = document.createElement('script');
            newScript.src = script.src;
            document.head.appendChild(newScript);
          } else if (script.textContent) {
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            document.head.appendChild(newScript);
          }
        });
        
      } catch (error) {
        mainContent.innerHTML = `
          <div class="page-container">
            <div class="section-header">
              <h1>Erro ao carregar ${title}</h1>
              </div>
            
            <div class="section-content">
              <p>Não foi possível carregar o conteúdo: ${error.message}</p>
            </div>
          </div>
        `;
        
      }
    }

  </script>

  <script>
    // Usar o mesmo db que já foi inicializado na versão moderna
    // Aguarda a inicialização do Firebase moderno e usa o mesmo
    setTimeout(() => {
      if (window.db) {
        window.dbCompat = window.db;
      }
    }, 1000);
  </script>

</body>
</html>
