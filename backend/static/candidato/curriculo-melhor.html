<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comparativo de Currículo • Original vs Melhorado</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Libre+Caslon+Text:ital,wght@0,400;0,700&display=swap" rel="stylesheet">
  
  <!-- jsPDF Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/components/buttons.css">
  <link rel="stylesheet" href="../css/pages/curriculo.css">
  
  <!-- Estilos específicos para impressão -->
  <style>
    @media print {
      /* TESTE SIMPLES - Oculta tudo e mostra apenas um texto */
      * {
        display: none !important;
      }
      
      body {
        display: block !important;
        background: white !important;
        margin: 0 !important;
        padding: 20px !important;
        font-family: Arial, sans-serif !important;
        font-size: 12pt !important;
        color: black !important;
      }
      
      body::before {
        content: "TESTE PDF - Este é um teste simples de impressão. Se você está vendo isto, o botão PDF está funcionando!";
        display: block !important;
        font-size: 18pt !important;
        font-weight: bold !important;
        margin: 50px 0 !important;
        text-align: center !important;
      }
      
      @page {
        size: A4;
        margin: 2cm;
      }
    }
  </style>
  
</head>
<body class="curriculo-page">

  <header>
    <h1>Comparativo de Currículo</h1>
  </header>

  <div class="page">
    <!-- Versão melhorada -->
    <div class="resume" aria-label="Currículo melhorado">
      <div class="sidebar">
        <div>
          <p class="name" id="melhorado-nome">—</p>
          <p class="title" id="melhorado-cargo">—</p>
        </div>
        <div class="summary" id="melhorado-resumo">—</div>
        <div class="divider"></div>
        <div class="section">
          <div class="badge">VERSÃO MELHORADA</div>
          <div class="contact-item"><strong>Email:</strong>&nbsp;<span id="melhorado-email">—</span></div>
          <div class="contact-item"><strong>Telefone:</strong>&nbsp;<span id="melhorado-telefone">—</span></div>
          <div class="contact-item"><strong>LinkedIn:</strong>&nbsp;<span id="melhorado-linkedin">—</span></div>
        </div>
      </div>
      <div class="main">
        <div class="header-compare">
          <div class="meta-small">
            <div id="quality-display" class="quality-score">Qualidade estimada: —</div>
          </div>
          <div>
            <button class="btn" id="btnGerarIA">Melhorar com IA</button>
            <button class="btn btn-secondary" id="btnExportar">Exportar PDF</button>
          </div>
        </div>

        <div class="section">
          <h3>Educação</h3>
          <div id="melhorado-educacao"></div>
        </div>

        <div class="section">
          <h3>Experiência</h3>
          <div id="melhorado-experiencia"></div>
        </div>

        <div class="section">
          <h3>Habilidades</h3>
          <div id="melhorado-habilidades"></div>
        </div>

        <div class="analysis-box" id="analise-box">
          <div class="analysis-title">Diagnóstico &amp; Recomendações</div>
          <div><strong>Métricas faltantes:</strong> <span id="missing-metrics">—</span></div>
          <div><strong>Verbos fracos detectados:</strong> <span id="weak-verbs">—</span></div>
          <div class="recommendations">
            <div><strong>Recomendações:</strong></div>
            <div id="recommendations-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Versão original -->
    <div class="resume" aria-label="Currículo original">
      <div class="sidebar">
        <div>
          <p class="name" id="original-nome">—</p>
          <p class="title" id="original-cargo">—</p>
        </div>
        <div class="summary" id="original-resumo">—</div>
        <div class="divider"></div>
        <div class="section">
          <div class="badge" style="background:#888;">VERSÃO ORIGINAL</div>
          <div class="contact-item"><strong>Email:</strong>&nbsp;<span id="original-email">—</span></div>
          <div class="contact-item"><strong>Telefone:</strong>&nbsp;<span id="original-telefone">—</span></div>
          <div class="contact-item"><strong>LinkedIn:</strong>&nbsp;<span id="original-linkedin">—</span></div>
        </div>
      </div>
      <div class="main">
        <div class="header-compare">
          <div class="meta-small">Base</div>
        </div>

        <div class="section">
          <h3>Educação</h3>
          <div id="original-educacao"></div>
        </div>

        <div class="section">
          <h3>Experiência</h3>
          <div id="original-experiencia"></div>
        </div>

        <div class="section">
          <h3>Habilidades</h3>
          <div id="original-habilidades"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === configuração Firebase ===
    // Usar o Firebase moderno que já está inicializado
    let db = window.db;
    
    // Verificação de segurança para garantir que o db está disponível
    let dbAvailable = !!db;
    if (!dbAvailable) {
      console.warn('Firebase DB não está disponível ainda.');
      // A inicialização será feita pela função inicializarPagina()
    }
    
    // Executa inicialização IMEDIATAMENTE para evitar problemas de script
    setTimeout(() => {
      if (typeof inicializarPagina === 'function') {
        inicializarPagina();
      } else {
      }
    }, 100);

    // toast utilitário
    function showToast(message, { fallback=false } = {}) {
      const div = document.createElement('div');
      div.className = 'toast' + (fallback ? ' fallback' : '');
      div.textContent = message;
      document.body.appendChild(div);
      setTimeout(() => {
        div.style.opacity = '0';
        setTimeout(() => div.remove(), 400);
      }, 3000);
    }

    // DOM helpers
    function createEducationEntry(container, title, institution, range) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="item-header">
          <div class="item-title">${title}</div>
          <div class="item-meta">${range}</div>
        </div>
        <div class="subtle">${institution}</div>
      `;
      container.appendChild(div);
    }
    function createExperienceEntry(container, cargo, empresa, periodo, descricao) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="item-header">
          <div class="item-title">${cargo}</div>
          <div class="item-meta">${periodo}</div>
        </div>
        <div class="subtle">${empresa}</div>
        <div class="small">${descricao}</div>
      `;
      container.appendChild(div);
    }
    function createSkillEntry(container, nome, nivelPercent) {
      const div = document.createElement('div');
      div.className = 'skill';
      div.innerHTML = `
        <div class="skill-name"><span>${nome}</span><span class="skill-percentage">${nivelPercent}%</span></div>
        <div class="bar-wrapper"><div class="bar" style="width:${nivelPercent}%;"></div></div>
      `;
      container.appendChild(div);
    }

    // globais
    let curriculoOriginal = null;
    let analiseDocId = null; // para atualizar se existir

    // verbos e utilitários
    const STRONG_VERBS = [
      "Liderou", "Desenvolveu", "Implementou", "Otimizou", "Automatizou",
      "Conduziu", "Aumentou", "Reduziu", "Criou", "Projetou", "Estruturou",
      "Melhorou", "Orquestrou", "Estabeleceu"
    ];
    const WEAK_VERBS = ["responsável por", "ajudou", "trabalhou com", "participou de", "faz parte de", "auxiliou"];

    function detectWeakVerbs(text) {
      if (!text) return [];
      const lowered = text.toLowerCase();
      return WEAK_VERBS.filter(v => lowered.includes(v));
    }

    function normalizeSkillName(raw) {
      if (!raw) return '';
      return raw.trim().replace(/\bpython\b/i, 'Python').replace(/\bjava\b/i, 'Java');
    }

    function inferSkillLevel(skillName, experiencias = []) {
      const lower = skillName.toLowerCase();
      const inExp = (experiencias || []).some(exp => exp.descricao && exp.descricao.toLowerCase().includes(lower));
      return inExp ? 90 : 75;
    }

    function rewriteExperienceFallback(exp) {
      const verb = STRONG_VERBS[Math.floor(Math.random() * STRONG_VERBS.length)];
      const descricaoBase = exp.descricao || '';
      const temPercent = /\d+%/.test(descricaoBase);
      let impacto = '';
      if (temPercent) {
        impacto = descricaoBase.match(/(\d+%)/)[1];
      } else {
        const impactos = [
          "melhorando a eficiência dos relatórios",
          "reduzindo o tempo de processamento de dados",
          "aumentando a clareza das decisões estratégicas",
          "otimizando fluxos e automatizando tarefas repetitivas",
          "estruturando insights acionáveis para stakeholders"
        ];
        impacto = impactos[Math.floor(Math.random() * impactos.length)];
      }

      let bullet = `${verb} ${exp.empresa ? `na ${exp.empresa} ` : ''}em ${exp.cargo || ''}, ${impacto}`;
      if (exp.inicio) {
        bullet += ` durante ${exp.inicio}`;
      }
      if (!bullet.trim().startsWith("-")) bullet = `- ${bullet.trim()}.`;
      else if (!bullet.trim().endsWith(".")) bullet = bullet.trim() + ".";
      return bullet;
    }

    function rewriteSummaryFallback(resumo, experiencias = [], habilidades = []) {
      if (!resumo && experiencias.length === 0) return '';
      const skillList = (habilidades || []).map(h => normalizeSkillName(h).toUpperCase());
      const uniqSkills = [...new Set(skillList)].slice(0, 3);
      const topSkills = uniqSkills.join(', ');
      const cargos = experiencias.map(e => e.cargo).filter(Boolean);
      const primaryRole = cargos[0] || '';

      const phrases = [];

      if (primaryRole) {
        phrases.push(`Especialista em ${primaryRole} com foco em transformar dados em decisões acionáveis`);
      }

      if (topSkills) {
        phrases.push(`Experiência com ${topSkills} para entregar soluções escaláveis`);
      }

      const anosMatch = resumo ? (resumo.match(/(\d+)\s+anos?/i) || [])[1] : null;
      if (anosMatch && primaryRole) {
        phrases[0] = `Especialista em ${primaryRole} com ${anosMatch} anos de experiência transformando dados em insights de alto impacto`;
      }

      if (resumo) {
        const extra = resumo.split('.').filter(p => p.trim()).slice(0,1)[0];
        if (extra && !phrases.some(p => p.includes(extra))) {
          phrases.push(extra.replace(/\.$/, ''));
        }
      }

      const result = phrases.slice(0, 3).join('. ') + '.';
      return result;
    }

    function suggestTitleFallback(originalTitle, experiencias = [], habilidades = []) {
      let title = originalTitle || 'Especialista em Dados';
      const temVariosAnos = (experiencias || []).some(exp => {
        if (!exp.inicio) return false;
        const m = exp.inicio.match(/(\d{4})/);
        if (!m) return false;
        return parseInt(m[1]) <= new Date().getFullYear() - 3;
      });

      if (/Analista de Dados/i.test(title)) {
        title = temVariosAnos ? 'Especialista Sênior em Inteligência de Dados' : 'Especialista em Inteligência de Dados & Automação';
      } else if (/Engenheiro/i.test(title)) {
        title = temVariosAnos ? 'Engenheiro de Dados Sênior' : 'Engenheiro de Dados';
      }

      if (habilidades && habilidades.length) {
        const top = normalizeSkillName(habilidades[0]);
        title += ` • ${top}`;
      }

      return title;
    }

    function analyzeGaps(curr) {
      const missing_metrics = [];
      const weak_verbs_detected = [];
      const recommendations = [];

      (curr.experiencias || []).forEach(exp => {
        if (!/\d+%/.test(exp.descricao || "")) {
          missing_metrics.push(`${exp.cargo} na ${exp.empresa}`);
          recommendations.push(`Adicionar um resultado quantificável para "${exp.cargo}" (ex: "aumentou X em Y%" ou "reduziu tempo em Z%").`);
        }
        const weak = detectWeakVerbs(exp.descricao || "");
        if (weak.length) {
          weak_verbs_detected.push(...weak);
          recommendations.push(`Substituir verbos genéricos como ${weak.map(w => `"${w}"`).join(', ')} por verbos de ação fortes como "Liderou", "Implementou", "Otimizou".`);
        }
      });

      if (!curr.resumo || curr.resumo.split(" ").length < 25) {
        recommendations.push("Expandir o resumo com especialização, habilidades-chave e impacto concreto. Ex: 'Especialista em Inteligência de Dados com 5 anos, entregando dashboards que reduziram custos em 15%.'");
      }

      return {
        missing_metrics,
        weak_verbs: [...new Set(weak_verbs_detected)],
        recommendations: [...new Set(recommendations)]
      };
    }

    function computeQualityScore(analise) {
      let score = 100;
      if (analise.missing_metrics.length) score -= 10 * analise.missing_metrics.length;
      if (analise.weak_verbs.length) score -= 5 * analise.weak_verbs.length;
      return Math.max(50, score);
    }

    // carga inicial de possível análise salva
    async function carregarAnaliseExistente(userEmail) {
      if (!db) {
        console.warn('Firebase DB não disponível para carregar análise existente');
        return false;
      }
      const { collection, query, where, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
      const q = query(collection(db, 'curriculos-ia'), where('userEmail', '==', userEmail), limit(1));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const doc = snap.docs[0];
        analiseDocId = doc.id;
        const saved = doc.data();
        // aplica no DOM como se tivesse sido gerado
        // versão original básica (já carregada por carregarCurriculoReal)
        if (saved.analise) {
          document.getElementById("missing-metrics").textContent = saved.analise.missing_metrics?.length
            ? saved.analise.missing_metrics.join(", ")
            : "Nenhum detectado";
          document.getElementById("weak-verbs").textContent = saved.analise.weak_verbs?.length
            ? saved.analise.weak_verbs.join(", ")
            : "Nenhum detectado";
          const recList = document.getElementById("recommendations-list");
          recList.innerHTML = "";
          (saved.analise.recommendations || []).forEach(r => {
            const div = document.createElement('div');
            div.className = "recommendation-item";
            div.innerHTML = `<div class="pill">✔</div><div>${r}</div>`;
            recList.appendChild(div);
          });
        }
        if (saved.resumo_melhorado) {
          document.getElementById("melhorado-resumo").textContent = saved.resumo_melhorado;
        }
        if (saved.sugestao_cargo) {
          document.getElementById("melhorado-cargo").textContent = saved.sugestao_cargo;
        }
        if (Array.isArray(saved.experiencias_melhoradas)) {
          const container = document.getElementById("melhorado-experiencia");
          container.innerHTML = "";
          saved.experiencias_melhoradas.forEach(txt => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<div class="subtle">${txt}</div>`;
            container.appendChild(div);
          });
        }
        if (saved.quality_score !== undefined) {
          document.getElementById("quality-display").textContent = `Qualidade estimada: ${saved.quality_score}/100`;
        }
        // habilidades (normalizadas)
        const melHab = document.getElementById("melhorado-habilidades");
        melHab.innerHTML = '';
        (curriculoOriginal.habilidades || []).forEach(h => {
          const nome = normalizeSkillName(h);
          const nivel = inferSkillLevel(nome, curriculoOriginal.experiencias);
          createSkillEntry(melHab, nome, nivel);
        });
        showToast("Usando análise salva anteriormente.");
        return true;
      }
      return false;
    }

    // salvar ou atualizar análise
    async function persistirAnalise(userEmail, resultado) {
      if (!db) {
        console.warn('Firebase DB não disponível para persistir análise');
        return;
      }
      const { collection, doc, updateDoc, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
      const payload = {
        userEmail,
        resumo_melhorado: resultado.resumo_melhorado,
        sugestao_cargo: resultado.sugestao_cargo,
        experiencias_melhoradas: resultado.experiencias_melhoradas,
        analise: resultado.analise,
        quality_score: computeQualityScore(resultado.analise),
        atualizadoEm: serverTimestamp()
      };
      try {
        if (analiseDocId) {
          await updateDoc(doc(db, 'curriculos-ia', analiseDocId), payload);
        } else {
          const docRef = await addDoc(collection(db, 'curriculos-ia'), payload);
          analiseDocId = docRef.id;
        }
      } catch (e) {
        console.warn("Erro salvando análise no Firebase:", e);
      }
    }

    // melhoria principal
    async function melhorarCurriculoComIA() {
      if (!db) {
        showToast("Firebase não disponível", { fallback: true });
        return;
      }
      
      // SEMPRE recarrega os dados mais recentes antes de processar
      try {
        showToast("Recarregando dados mais recentes...");
        await inicializarFluxo();
        
        if (!curriculoOriginal) {
          showToast("Nenhum currículo encontrado. Crie um currículo primeiro em 'Meu Perfil'.", { fallback: true });
          return;
        }
        
        showToast("Dados recarregados! Processando com IA...");
      } catch (e) {
        showToast("Erro ao recarregar dados", { fallback: true });
        return;
      }

      // Prioriza candidateEmail que é o email do usuário logado
      const userEmail = localStorage.getItem('candidateEmail') || localStorage.getItem('userEmail') || '';
      if (!userEmail) {
        showToast("Email do usuário ausente", { fallback: true });
        return;
      }

      const experienciaTexto = (curriculoOriginal.experiencias || []).map(exp =>
        `Cargo: ${exp.cargo}\nEmpresa: ${exp.empresa}\nPeríodo: ${exp.inicio || ''} – ${exp.fim || 'Atual'}\nDescrição: ${exp.descricao}`
      ).join("\n\n");
      const formacoesTexto = (curriculoOriginal.formacoes || []).map(f =>
        `Curso: ${f.curso}\nInstituição: ${f.instituicao}\nAno de conclusão: ${f.anoConclusao}`
      ).join("\n\n");
      const habilidadesTexto = (curriculoOriginal.habilidades || []).join(", ");

      const prompt = `
Você é um especialista em currículos de alto impacto. Analise o currículo abaixo e gere melhorias competitivas.

Currículo original:
Resumo:
${curriculoOriginal.resumo || ''}

Experiências:
${experienciaTexto}

Formações:
${formacoesTexto}

Habilidades:
${habilidadesTexto}

Instruções:
1. Reescreva o resumo para que seja conciso e orientado a resultados (2-3 frases).
2. Sugira um título de cargo mais forte com seniority quando aplicável.
3. Reescreva cada experiência em bullets com verbos de ação fortes e impacto claro.
4. Identifique gaps (falta de métricas, verbos genéricos) e dê recomendações.

Retorne JSON com:
- resumo_melhorado
- sugestao_cargo
- experiencias_melhoradas (array de strings)
- analise: { missing_metrics, weak_verbs, recommendations }
`;

      let finalResult = null;
      let usedFallback = false;

      try {
        const GEMINI_API_KEY = "AIzaSyCuUt5tLclO6vhUSoe3-MSBnPF5ETcrQis"; // substitua
        const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`;
        const body = {
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            response_mime_type: "application/json",
            temperature: 0.4,
            topK: 1,
            topP: 1,
            maxOutputTokens: 2000
          }
        };
        const resp = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const raw = await resp.text();
        if (resp.ok) {
          let parsed = null;
          try {
            const first = raw.indexOf("{");
            const last = raw.lastIndexOf("}");
            if (first !== -1 && last !== -1 && last > first) {
              parsed = JSON.parse(raw.substring(first, last + 1));
            }
          } catch (e) {
            console.warn("Falha ao parsear JSON da IA:", e);
          }
          if (parsed && parsed.resumo_melhorado) {
            finalResult = parsed;
          }
        }
      } catch (e) {
        console.warn("Erro chamando Gemini:", e);
      }

      if (!finalResult) {
        usedFallback = true;
        finalResult = {
          resumo_melhorado: rewriteSummaryFallback(curriculoOriginal.resumo || '', curriculoOriginal.experiencias || [], curriculoOriginal.habilidades || []),
          sugestao_cargo: suggestTitleFallback(
            curriculoOriginal.experiencias?.[0]?.cargo || '',
            curriculoOriginal.experiencias || [],
            curriculoOriginal.habilidades || []
          ),
          experiencias_melhoradas: (curriculoOriginal.experiencias || []).map(rewriteExperienceFallback),
          analise: analyzeGaps(curriculoOriginal)
        };
      } else {
        if (!finalResult.resumo_melhorado) {
          finalResult.resumo_melhorado = rewriteSummaryFallback(curriculoOriginal.resumo || '', curriculoOriginal.experiencias || [], curriculoOriginal.habilidades || []);
        }
        if (!finalResult.sugestao_cargo) {
          finalResult.sugestao_cargo = suggestTitleFallback(
            curriculoOriginal.experiencias?.[0]?.cargo || '',
            curriculoOriginal.experiencias || [],
            curriculoOriginal.habilidades || []
          );
        }
        if (!finalResult.experiencias_melhoradas) {
          finalResult.experiencias_melhoradas = (curriculoOriginal.experiencias || []).map(rewriteExperienceFallback);
        }
        if (!finalResult.analise) {
          finalResult.analise = analyzeGaps(curriculoOriginal);
        }
      }

      // aplica conteúdo
      if (finalResult.resumo_melhorado) {
        document.getElementById("melhorado-resumo").textContent = finalResult.resumo_melhorado;
      }
      if (finalResult.sugestao_cargo) {
        document.getElementById("melhorado-cargo").textContent = finalResult.sugestao_cargo;
      }

      const melExp = document.getElementById("melhorado-experiencia");
      melExp.innerHTML = "";
      (finalResult.experiencias_melhoradas || []).forEach(txt => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div class="subtle">${txt}</div>`;
        melExp.appendChild(div);
      });

      // habilidades normalizadas
      const melHab = document.getElementById("melhorado-habilidades");
      melHab.innerHTML = '';
      (curriculoOriginal.habilidades || []).forEach(h => {
        const nome = normalizeSkillName(h);
        const nivel = inferSkillLevel(nome, curriculoOriginal.experiencias);
        createSkillEntry(melHab, nome, nivel);
      });

      // diagnóstico visual
      document.getElementById("missing-metrics").textContent = finalResult.analise.missing_metrics.length
        ? finalResult.analise.missing_metrics.join(", ")
        : "Nenhum detectado";
      document.getElementById("weak-verbs").textContent = finalResult.analise.weak_verbs.length
        ? finalResult.analise.weak_verbs.join(", ")
        : "Nenhum detectado";

      const recList = document.getElementById("recommendations-list");
      recList.innerHTML = "";
      finalResult.analise.recommendations.forEach(r => {
        const div = document.createElement('div');
        div.className = "recommendation-item";
        div.innerHTML = `<div class="pill">✔</div><div>${r}</div>`;
        recList.appendChild(div);
      });

      // quality score
      const score = computeQualityScore(finalResult.analise);
      document.getElementById("quality-display").textContent = `Qualidade estimada: ${score}/100`;

      // persistir
      await persistirAnalise(userEmail, finalResult);

      // notificação
      if (usedFallback) {
        showToast("Melhoria local aplicada e salva", { fallback: true });
      } else {
        showToast("Melhoria com IA aplicada e salva com sucesso");
      }
    }

    // carrega currículo real e possível análise existente
    async function inicializarFluxo() {
      // Prioriza candidateEmail que é o email do usuário logado
      const userEmail = localStorage.getItem('candidateEmail') || localStorage.getItem('userEmail') || '';
      if (!userEmail) {
        showToast("Email do usuário não encontrado. Faça login novamente.", { fallback: true });
        return;
      }

      if (!db) {
        showToast('Conectando ao banco de dados...', { fallback: true });
        return;
      }

      try {
        // carrega currículo
        showToast("Carregando seu currículo...");
        const { collection, query, where, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
        const curriculoQuery = query(collection(db, 'curriculo'), where('email', '==', userEmail), limit(1));
        const snap = await getDocs(curriculoQuery);
        
        if (snap.empty) {
          showToast("Nenhum currículo encontrado. Crie um currículo primeiro em 'Meu Perfil'.", { fallback: true });
          // Mostra mensagem visual na interface
          document.getElementById('quality-display').textContent = 'Nenhum currículo encontrado';
          document.getElementById('missing-metrics').textContent = 'Crie um currículo primeiro';
          document.getElementById('weak-verbs').textContent = 'Vá em Meu Perfil → Criador de Currículo';
          const recList = document.getElementById('recommendations-list');
          recList.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="margin-bottom: 15px;">Para usar esta funcionalidade, você precisa primeiro criar um currículo:</p>
              <ol style="text-align: left; margin: 15px 0;">
                <li>Clique em "Meu Perfil" (ou no botão abaixo)</li>
                <li>Preencha o "Criador de Currículo"</li>
                <li>Clique em "Salvar Currículo"</li>
                <li>Volte aqui e clique em "Melhorar com IA"</li>
              </ol>
              <button onclick="if(window.candidateRouter) window.candidateRouter.navigateTo('/candidato/perfil')" 
                      style="background: #39ff14; color: #000; border: none; padding: 12px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px;">
                Ir para Criador de Currículo
              </button>
            </div>
          `;
          return;
        }
        
        const data = snap.docs[0].data();
        curriculoOriginal = data;
        
        showToast("Currículo carregado com sucesso!");

        // original
      document.getElementById('original-nome').textContent = data.nome || '';
      document.getElementById('original-cargo').textContent = data.experiencias && data.experiencias[0]?.cargo ? data.experiencias[0].cargo : '';
      document.getElementById('original-resumo').textContent = data.resumo || '';
      document.getElementById('original-email').textContent = data.email || userEmail;
      document.getElementById('original-telefone').textContent = data.telefone || '';
      document.getElementById('original-linkedin').textContent = data.linkedin || '';

      // melhorado preliminar
      document.getElementById('melhorado-nome').textContent = data.nome || '';
      document.getElementById('melhorado-email').textContent = data.email || '';
      document.getElementById('melhorado-telefone').textContent = data.telefone || '';
      document.getElementById('melhorado-linkedin').textContent = data.linkedin || '';
      document.getElementById('melhorado-resumo').textContent = data.resumo || '';
      document.getElementById('melhorado-cargo').textContent = suggestTitleFallback(
        data.experiencias?.[0]?.cargo || '',
        data.experiencias || [],
        data.habilidades || []
      );

      // educação
      const origEdu = document.getElementById('original-educacao');
      const melEdu = document.getElementById('melhorado-educacao');
      origEdu.innerHTML = '';
      melEdu.innerHTML = '';
      if (Array.isArray(data.formacoes)) {
        data.formacoes.forEach(f => {
          createEducationEntry(origEdu, f.curso || '', f.instituicao || '', f.anoConclusao || '');
          createEducationEntry(melEdu, f.curso || '', f.instituicao || '', f.anoConclusao || '');
        });
      }

      // experiência
      const origExp = document.getElementById('original-experiencia');
      const melExp = document.getElementById('melhorado-experiencia');
      origExp.innerHTML = '';
      melExp.innerHTML = '';
      if (Array.isArray(data.experiencias)) {
        data.experiencias.forEach(exp => {
          const periodo = `${exp.inicio || ''} – ${exp.fim || 'Atual'}`;
          createExperienceEntry(origExp, exp.cargo || '', exp.empresa || '', periodo, exp.descricao || '');
          createExperienceEntry(melExp, exp.cargo || '', exp.empresa || '', periodo, exp.descricao || '');
        });
      }

      // habilidades
      const origHab = document.getElementById('original-habilidades');
      const melHab = document.getElementById('melhorado-habilidades');
      origHab.innerHTML = '';
      melHab.innerHTML = '';
      if (Array.isArray(data.habilidades)) {
        data.habilidades.forEach(h => {
          const nome = normalizeSkillName(h);
          const nivel = inferSkillLevel(nome, data.experiencias);
          createSkillEntry(origHab, nome, nivel);
          createSkillEntry(melHab, nome, nivel);
        });
      }

        // carrega análise anterior se houver
        await carregarAnaliseExistente(userEmail);
        
      } catch (error) {
        console.error('Erro ao carregar currículo:', error);
        showToast('Erro ao carregar currículo. Tente novamente.', { fallback: true });
        
        // Mostra mensagem de erro na interface
        document.getElementById('quality-display').textContent = 'Erro ao carregar dados';
        document.getElementById('missing-metrics').textContent = 'Erro de conexão';
        document.getElementById('weak-verbs').textContent = 'Tente recarregar a página';
      }
    }

    // Função recarregarCurriculo removida - funcionalidade transferida para melhorarCurriculoComIA

    // Função para gerar PDF do currículo
    function gerarPDFCurriculo() {
      try {
        // Inicializa jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configurações
        const pageWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const margin = 15;
        const sidebarWidth = 70;
        const mainWidth = pageWidth - sidebarWidth - margin * 2;
        
        // Coleta dados do currículo melhorado
        const nome = document.getElementById('melhorado-nome').textContent || '';
        const cargo = document.getElementById('melhorado-cargo').textContent || '';
        const resumo = document.getElementById('melhorado-resumo').textContent || '';
        const email = document.getElementById('melhorado-email').textContent || '';
        const telefone = document.getElementById('melhorado-telefone').textContent || '';
        const linkedin = document.getElementById('melhorado-linkedin').textContent || '';
        
        // SIDEBAR (cor de fundo)
        doc.setFillColor(248, 249, 250); // #f8f9fa
        doc.rect(0, 0, sidebarWidth + margin, pageHeight, 'F');
        
        // Linha vertical separadora
        doc.setDrawColor(221, 221, 221); // #ddd
        doc.line(sidebarWidth + margin, 0, sidebarWidth + margin, pageHeight);
        
        let yPos = 20;
        
        // SIDEBAR - Nome
        doc.setTextColor(51, 51, 51); // #333
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(nome, margin, yPos);
        yPos += 8;
        
        // SIDEBAR - Cargo
        doc.setTextColor(102, 102, 102); // #666
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(cargo, margin, yPos);
        yPos += 15;
        
        // SIDEBAR - Resumo
        doc.setTextColor(85, 85, 85); // #555
        doc.setFontSize(10);
        const resumoLines = doc.splitTextToSize(resumo, sidebarWidth - 5);
        doc.text(resumoLines, margin, yPos);
        yPos += resumoLines.length * 4 + 15;
        
        // Divisor (linha)
        doc.setDrawColor(221, 221, 221);
        doc.line(margin, yPos, sidebarWidth, yPos);
        yPos += 12;
        
        // SIDEBAR - Contatos
        doc.setTextColor(85, 85, 85); // #555
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        doc.setFont(undefined, 'bold');
        doc.text('Email: ', margin, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(email, margin + 15, yPos);
        yPos += 6;
        
        doc.setFont(undefined, 'bold');
        doc.text('Telefone: ', margin, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(telefone, margin + 22, yPos);
        yPos += 6;
        
        doc.setFont(undefined, 'bold');
        doc.text('LinkedIn: ', margin, yPos);
        doc.setFont(undefined, 'normal');
        const linkedinText = linkedin.length > 25 ? linkedin.substring(0, 22) + '...' : linkedin;
        doc.text(linkedinText, margin + 20, yPos);
        
        // CONTEÚDO PRINCIPAL
        const mainStartX = sidebarWidth + margin * 2;
        yPos = 20;
        
        // Educação
        doc.setTextColor(51, 51, 51); // #333
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Educação', mainStartX, yPos);
        yPos += 3;
        
        // Linha sob título
        doc.setDrawColor(221, 221, 221);
        doc.line(mainStartX, yPos, mainStartX + mainWidth - 10, yPos);
        yPos += 12;
        
        // Itens de educação
        const educacaoItems = document.querySelectorAll('#melhorado-educacao .item');
        educacaoItems.forEach(item => {
          const titulo = item.querySelector('.item-title')?.textContent || '';
          const instituicao = item.querySelector('.subtle')?.textContent || '';
          
          doc.setFontSize(11);
          doc.setFont(undefined, 'bold');
          doc.text(titulo, mainStartX, yPos);
          yPos += 4;
          
          doc.setTextColor(102, 102, 102);
          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');
          doc.text(instituicao, mainStartX, yPos);
          yPos += 15;
        });
        
        // Experiência
        doc.setTextColor(51, 51, 51);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Experiência', mainStartX, yPos);
        yPos += 3;
        
        doc.setDrawColor(221, 221, 221);
        doc.line(mainStartX, yPos, mainStartX + mainWidth - 10, yPos);
        yPos += 12;
        
        // Itens de experiência
        const experienciaItems = document.querySelectorAll('#melhorado-experiencia .item');
        experienciaItems.forEach(item => {
          const descricao = item.querySelector('.subtle')?.textContent || '';
          
          doc.setTextColor(102, 102, 102);
          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');
          const descLines = doc.splitTextToSize(descricao, mainWidth - 10);
          doc.text(descLines, mainStartX, yPos);
          yPos += descLines.length * 4 + 10;
        });
        
        // Habilidades
        doc.setTextColor(51, 51, 51);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Habilidades', mainStartX, yPos);
        yPos += 3;
        
        doc.setDrawColor(221, 221, 221);
        doc.line(mainStartX, yPos, mainStartX + mainWidth - 10, yPos);
        yPos += 12;
        
        // Itens de habilidades
        const habilidadeItems = document.querySelectorAll('#melhorado-habilidades .skill');
        habilidadeItems.forEach(skill => {
          const nome = skill.querySelector('.skill-name span:first-child')?.textContent || '';
          const porcentagem = skill.querySelector('.skill-percentage')?.textContent || '';
          const porcentagemNum = parseInt(porcentagem.replace('%', '')) || 0;
          
          doc.setTextColor(51, 51, 51);
          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');
          doc.text(nome, mainStartX, yPos);
          
          doc.setTextColor(40, 167, 69);
          doc.setFont(undefined, 'bold');
          doc.text(porcentagem, mainStartX + mainWidth - 20, yPos);
          
          // Barra de progresso
          const barWidth = mainWidth - 30;
          const progressWidth = (barWidth * porcentagemNum) / 100;
          
          // Fundo da barra
          doc.setFillColor(233, 236, 239); // #e9ecef
          doc.rect(mainStartX, yPos + 2, barWidth, 2, 'F');
          
          // Progresso da barra
          doc.setFillColor(40, 167, 69); // #28a745
          doc.rect(mainStartX, yPos + 2, progressWidth, 2, 'F');
          
          yPos += 10;
        });
        
        // Nome do arquivo
        const nomeArquivo = nome ? `curriculo-${nome.replace(/\s+/g, '-').toLowerCase()}.pdf` : 'curriculo-melhorado.pdf';
        
        // Salva o PDF
        doc.save(nomeArquivo);
        
        showToast('PDF do currículo gerado com sucesso!');
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('Erro ao gerar PDF: ' + error.message, { fallback: true });
      }
    }

    // Função para configurar os event listeners dos botões (global)
    window.setupCurriculoButtons = function setupCurriculoButtons() {
      const btnGerarIA = document.getElementById("btnGerarIA");
      const btnExportar = document.getElementById("btnExportar");
      
      if (btnGerarIA) {
        // Remove listener existente se houver e adiciona novo
        btnGerarIA.removeEventListener("click", melhorarCurriculoComIA);
        btnGerarIA.addEventListener("click", melhorarCurriculoComIA);
      }
      
      if (btnExportar) {
        // Remove listener existente se houver e adiciona novo
        btnExportar.removeEventListener("click", gerarPDFCurriculo);
        btnExportar.addEventListener("click", gerarPDFCurriculo);
      }
    }

    // Função para aguardar window.db estar disponível
    async function aguardarDB(maxTentativas = 10) {
      for (let i = 0; i < maxTentativas; i++) {
        if (window.db) {
          db = window.db;
          dbAvailable = true;
          return true;
        }
        await new Promise(resolve => setTimeout(resolve, 300));
      }
      return false;
    }

    // inicialização
    async function inicializarPagina() {
      // Limpa userEmail para evitar conflitos e garantir uso do candidateEmail correto
      if (localStorage.getItem('candidateEmail')) {
        localStorage.removeItem('userEmail');
      }
      
      // Mostra loading inicial
      document.getElementById('quality-display').textContent = 'Conectando...';
      document.getElementById('missing-metrics').textContent = 'Aguarde';
      document.getElementById('weak-verbs').textContent = 'Carregando dados';
      
      // Sempre configura os botões primeiro
      window.setupCurriculoButtons();
      
      if (dbAvailable || await aguardarDB()) {
        try {
          await inicializarFluxo();
          // Configura os botões novamente após carregar dados
          setTimeout(window.setupCurriculoButtons, 200);
        } catch (error) {
          console.error('Erro na inicialização:', error);
          showToast('Erro ao carregar dados do currículo', { fallback: true });
          
          // Mostra erro na interface
          document.getElementById('quality-display').textContent = 'Erro na conexão';
          document.getElementById('missing-metrics').textContent = 'Erro ao carregar dados';
          document.getElementById('weak-verbs').textContent = 'Tente recarregar';
        }
      } else {
        console.warn('Database não disponível após múltiplas tentativas');
        showToast('Erro de conexão com banco de dados', { fallback: true });
        
        // Mostra erro na interface  
        document.getElementById('quality-display').textContent = 'Sem conexão';
        document.getElementById('missing-metrics').textContent = 'Base de dados indisponível';
        document.getElementById('weak-verbs').textContent = 'Verifique sua conexão';
      }
    }
    
    // Executa inicialização com tratamento de erro
    try {
      inicializarPagina();
    } catch (error) {
      console.error('Erro na inicialização da página:', error);
      // Mesmo com erro, tenta configurar botões básicos
      setTimeout(() => {
        if (window.setupCurriculoButtons) {
          window.setupCurriculoButtons();
        }
      }, 500);
    }
    
    // Backup: força inicialização após delay caso não tenha funcionado
    setTimeout(() => {
      if (document.getElementById('quality-display').textContent === 'Qualidade estimada: —') {
        inicializarPagina();
      }
    }, 2000);
  </script>
</body>
</html>
