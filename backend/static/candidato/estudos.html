<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lumii • Meus Estudos</title>
  
  <!-- Cache busting meta tags -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- Version for cache busting -->
  <meta name="version" content="2025-01-09-final" />
  
  <!-- External CSS Files -->
  <link rel="stylesheet" href="../css/base.css?v=2025-01-09-final">
  <link rel="stylesheet" href="../css/pages/estudos.css?v=2025-01-09-final">
</head>
<body class="estudos-page">

  <h1 style="margin-bottom: 30px;">Meus Materiais de Aperfeiçoamento</h1>
  <div id="estudosContainer">
    <!-- Caixinhas serão inseridas aqui -->
  </div>
  
  <!-- Force style refresh -->
  <div style="display: none;" id="style-refresh-trigger"></div>

  <script src="../js/firebase-config.js?v=20250109-final"></script>
  <script type="module">
    // Force style recomputation (silent)
    function forceStyleRefresh() {
      const trigger = document.getElementById('style-refresh-trigger');
      if (trigger) {
        trigger.style.display = 'block';
        trigger.offsetHeight; // Force reflow
        trigger.style.display = 'none';
      }
      
      const styleSheets = document.styleSheets;
      for (let sheet of styleSheets) {
        try {
          sheet.disabled = true;
          sheet.disabled = false;
        } catch (e) {
          // Cross-origin stylesheets may throw errors
        }
      }
      
      document.body.offsetHeight;
    }
    
    // Execute style refresh
    forceStyleRefresh();
    document.addEventListener('DOMContentLoaded', forceStyleRefresh);
    window.addEventListener('load', forceStyleRefresh);
    
    import { initializeApp }      from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getFirestore, collection, query, where, getDocs }
      from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // 1. Inicializa Firebase usando configuração do ambiente
    const firebaseConfig = await loadFirebaseConfig();
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // 2. Container onde as caixinhas serão renderizadas
    const container = document.getElementById('estudosContainer');

    // 3. Função para formatar data
    function formatDate(timestamp) {
      const date = timestamp.toDate();
      return date.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});
    }

    // 4. Carrega documentos da coleção
    (async function loadMateriais() {
      const companyEmail = localStorage.getItem('companyEmail');
      const candidateEmail = localStorage.getItem('candidateEmail');
      
      console.log('[ESTUDOS] Debug - companyEmail:', companyEmail);
      console.log('[ESTUDOS] Debug - candidateEmail:', candidateEmail);
      console.log('[ESTUDOS] Debug - db:', !!db);
      
      if (!companyEmail) {
        console.log('[ESTUDOS] Sem companyEmail, buscando empresas das candidaturas...');
        
        // Se não tem companyEmail, vamos buscar todas as empresas das candidaturas do usuário
        if (!candidateEmail) {
          console.log('[ESTUDOS] Erro: candidateEmail não encontrado');
          container.innerHTML = '<p style="text-align:center;color:#CCC;">Usuário não identificado.</p>';
          return;
        }
        
        // Busca todas as candidaturas do usuário para pegar as empresas
        const candidaturasRef = collection(db, 'candidaturas-realizadas');
        const candidaturasQuery = query(candidaturasRef, where('userEmail', '==', candidateEmail));
        const candidaturasSnap = await getDocs(candidaturasQuery);
        
        const respostasRef = collection(db, 'respostas-valores-dinamicas-trilhas');
        const respostasQuery = query(respostasRef, where('userEmail', '==', candidateEmail));
        const respostasSnap = await getDocs(respostasQuery);
        
        console.log('[ESTUDOS] Debug - candidaturasSnap.size:', candidaturasSnap.size);
        console.log('[ESTUDOS] Debug - respostasSnap.size:', respostasSnap.size);
        
        const empresasSet = new Set();
        candidaturasSnap.docs.forEach(doc => {
          const data = doc.data();
          if (data.companyEmail) empresasSet.add(data.companyEmail);
        });
        respostasSnap.docs.forEach(doc => {
          const data = doc.data();
          if (data.companyEmail) empresasSet.add(data.companyEmail);
        });
        
        const empresas = Array.from(empresasSet);
        console.log('[ESTUDOS] Debug - empresas encontradas:', empresas);
        
        if (empresas.length === 0) {
          console.log('[ESTUDOS] Nenhuma empresa encontrada nas candidaturas');
          container.innerHTML = '<p style="text-align:center;color:#CCC;">Nenhuma candidatura encontrada.</p>';
          return;
        }
        
        // Busca materiais de todas as empresas
        const allMateriais = [];
        for (const empresa of empresas) {
          console.log('[ESTUDOS] Debug - buscando materiais para empresa:', empresa);
          const colRef = collection(db, 'materiais_aperfeicoamento');
          const q = query(colRef, where('empresaEmail', '==', empresa));
          const snap = await getDocs(q);
          console.log('[ESTUDOS] Debug - materiais encontrados para', empresa, ':', snap.size);
          snap.docs.forEach(doc => {
            allMateriais.push({ ...doc.data(), empresa });
          });
        }
        
        console.log('[ESTUDOS] Debug - total de materiais:', allMateriais.length);
        
        if (allMateriais.length === 0) {
          console.log('[ESTUDOS] Nenhum material encontrado para as empresas');
          container.innerHTML = '<p style="text-align:center;color:#CCC;">Nenhum material encontrado para suas candidaturas.</p>';
          return;
        }
        
        // Renderiza todos os materiais
        allMateriais.forEach(data => {
          const box = document.createElement('div');
          box.className = 'material-box';
          box.setAttribute('data-tipo', data.tipo || 'pdf');

          const h2 = document.createElement('h2');
          h2.textContent = data.nome || 'Sem título';
          
          const pDesc = document.createElement('p');
          pDesc.innerHTML = `<strong>Descrição:</strong> ${data.descricao || '–'}`;
          
          const pTipo = document.createElement('p');
          pTipo.innerHTML = `<strong>Tipo:</strong> ${data.tipo || '–'}`;
          
          const divider = document.createElement('div');
          divider.className = 'material-divider';
          
          const pData = document.createElement('p');
          pData.innerHTML = `<strong>Criado em:</strong> ${data.criadoEm ? formatDate(data.criadoEm) : '–'}`;

          const empresaBadge = document.createElement('div');
          empresaBadge.className = 'empresa-badge';
          empresaBadge.textContent = data.empresa || '–';

          const actions = document.createElement('div');
          actions.className = 'material-actions';
          const openBtn = document.createElement('a');
          openBtn.href = data.arquivoUrl + '#toolbar=0&navpanes=0&scrollbar=0';
          openBtn.target = '_blank';
          openBtn.rel = 'noopener';
          openBtn.className = 'btn-open';
          openBtn.textContent = 'Abrir Material';

          actions.appendChild(openBtn);
          box.append(h2, pDesc, pTipo, divider, pData, empresaBadge, actions);
          container.appendChild(box);
        });
        
        return;
      }

      // consulta apenas os materiais desta empresa (lógica original)
      console.log('[ESTUDOS] Debug - consultando materiais para companyEmail:', companyEmail);
      const colRef = collection(db, 'materiais_aperfeicoamento');
      const q      = query(colRef, where('empresaEmail','==',companyEmail));
      const snap   = await getDocs(q);

      console.log('[ESTUDOS] Debug - materiais encontrados diretamente:', snap.size);

      if (snap.empty) {
        console.log('[ESTUDOS] Nenhum material encontrado para companyEmail');
        container.innerHTML = '<p style="text-align:center;color:#CCC;">Nenhum material encontrado.</p>';
        return;
      }

      // para cada doc, cria a caixinha
      snap.docs.forEach(doc => {
        const data = doc.data();
        const box  = document.createElement('div');
        box.className = 'material-box';
        box.setAttribute('data-tipo', data.tipo || 'pdf');

        // título e descrição
        const h2 = document.createElement('h2');
        h2.textContent = data.nome || 'Sem título';
        
        const pDesc = document.createElement('p');
        pDesc.innerHTML = `<strong>Descrição:</strong> ${data.descricao || '–'}`;
        
        const pTipo = document.createElement('p');
        pTipo.innerHTML = `<strong>Tipo:</strong> ${data.tipo || '–'}`;
        
        const divider = document.createElement('div');
        divider.className = 'material-divider';
        
        const pData = document.createElement('p');
        pData.innerHTML = `<strong>Criado em:</strong> ${data.criadoEm ? formatDate(data.criadoEm) : '–'}`;

        // botões
        const actions = document.createElement('div');
        actions.className = 'material-actions';
        const openBtn = document.createElement('a');
        // adiciona fragmento para esconder toolbar e impedir download
        openBtn.href = data.arquivoUrl + '#toolbar=0&navpanes=0&scrollbar=0';
        openBtn.target = '_blank';
        openBtn.rel = 'noopener';
        openBtn.className = 'btn-open';
        openBtn.textContent = 'Abrir Material';

        actions.appendChild(openBtn);

        // montagem final
        box.append(h2, pDesc, pTipo, divider, pData, actions);
        container.appendChild(box);
      });
    })().catch(error => {
      console.error('[ESTUDOS] Erro ao carregar materiais:', error);
      container.innerHTML = '<p style="text-align:center;color:#CCC;">Erro ao carregar materiais: ' + error.message + '</p>';
    });
  </script>

</body>
</html>
